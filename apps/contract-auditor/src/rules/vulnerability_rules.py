"""
漏洞检测规则引擎

提供:
1. 可扩展的漏洞规则系统
2. 资金影响分析维度
3. 基于 YAML 的规则配置(启用/禁用、严重性、权重映射)
"""

from __future__ import annotations

from dataclasses import dataclass
from enum import Enum
from pathlib import Path
from typing import Any, Callable, Dict, List, Optional

import logging

import yaml

logger = logging.getLogger(__name__)


class VulnerabilityCategory(Enum):
    """漏洞分类"""

    REENTRANCY = "重入攻击"
    ACCESS_CONTROL = "权限绕过"
    PRECISION_LOSS = "精度丢失"
    INTEGER_OVERFLOW = "整数溢出"
    UNCHECKED_RETURN = "未检查返回值"
    TIMESTAMP_DEPENDENCE = "时间戳依赖"
    TX_ORIGIN = "tx.origin认证"
    DELEGATECALL = "delegatecall漏洞"
    SELFDESTRUCT = "selfdestruct滥用"
    SIGNATURE_REPLAY = "签名重放"
    FRONT_RUNNING = "抢跑攻击"
    UNPROTECTED_INITIALIZATION = "未保护初始化"


class FundImpact(Enum):
    """资金影响程度"""

    CRITICAL = "直接盗币"  # 可直接提取用户资金
    HIGH = "资金损失"  # 导致用户资金损失
    MEDIUM = "价值减少"  # 影响资产价值
    LOW = "间接影响"  # 间接影响资金安全
    NONE = "无影响"  # 不影响资金


@dataclass
class VulnerabilityRule:
    """单条漏洞检测规则"""

    category: VulnerabilityCategory
    name: str
    description: str
    fund_impact: FundImpact
    severity: str  # HIGH/MEDIUM/LOW

    # 检测模式
    patterns: List[str]  # 代码模式关键词
    exclusions: List[str]  # 排除模式

    # 上下文要求
    requires_external_call: bool = False
    requires_state_change: bool = False
    requires_value_transfer: bool = False

    # 修复建议
    recommendation: str = ""
    reference: str = ""  # 参考资料链接

    # 自定义检测函数
    custom_detector: Optional[Callable[[Dict[str, Any]], bool]] = None


class VulnerabilityRuleEngine:
    """规则引擎"""

    def __init__(self, config_path: Optional[str] = None) -> None:
        self.rules: List[VulnerabilityRule] = []
        self._category_config: Dict[VulnerabilityCategory, Dict[str, Any]] = {}
        self.fund_impact_weights: Dict[FundImpact, float] = {}
        self.severity_mapping: Dict[str, str] = {}

        if config_path is None:
            # 默认使用当前目录下的 rules.yaml
            self.config_path = Path(__file__).with_name("rules.yaml")
        else:
            self.config_path = Path(config_path)

        self._load_config()
        self._load_builtin_rules()
        self._apply_config_to_rules()

    # ------------------------------------------------------------------ #
    # 配置加载
    # ------------------------------------------------------------------ #
    def _load_config(self) -> None:
        """加载 YAML 规则配置"""
        if not self.config_path.is_file():
            logger.info("规则配置文件不存在, 使用内置默认配置: %s", self.config_path)
            return

        try:
            with self.config_path.open("r", encoding="utf-8") as f:
                config: Dict[str, Any] = yaml.safe_load(f) or {}
        except Exception as exc:  # noqa: BLE001
            logger.warning("加载规则配置失败, 使用默认配置: %s", exc)
            return

        # 规则启用/禁用与严重性配置
        category_lookup: Dict[str, VulnerabilityCategory] = {
            "reentrancy": VulnerabilityCategory.REENTRANCY,
            "access_control": VulnerabilityCategory.ACCESS_CONTROL,
            "precision_loss": VulnerabilityCategory.PRECISION_LOSS,
            "integer_overflow": VulnerabilityCategory.INTEGER_OVERFLOW,
            "unchecked_return": VulnerabilityCategory.UNCHECKED_RETURN,
            "timestamp_dependence": VulnerabilityCategory.TIMESTAMP_DEPENDENCE,
            "tx_origin": VulnerabilityCategory.TX_ORIGIN,
            "delegatecall": VulnerabilityCategory.DELEGATECALL,
            "selfdestruct": VulnerabilityCategory.SELFDESTRUCT,
            "signature_replay": VulnerabilityCategory.SIGNATURE_REPLAY,
            "front_running": VulnerabilityCategory.FRONT_RUNNING,
            "unprotected_initialization": VulnerabilityCategory.UNPROTECTED_INITIALIZATION,
        }

        rules_cfg = config.get("rules", []) or []
        for item in rules_cfg:
            cat_key = str(item.get("category", "")).lower()
            category = category_lookup.get(cat_key)
            if category:
                self._category_config[category] = item

        # 资金影响评分权重
        impact_cfg = config.get("fund_impact_weights", {}) or {}
        for name, weight in impact_cfg.items():
            if name in FundImpact.__members__:
                try:
                    self.fund_impact_weights[FundImpact[name]] = float(weight)
                except (TypeError, ValueError):
                    logger.warning("非法资金权重配置(%s=%s), 已忽略", name, weight)

        # 严重性映射
        self.severity_mapping = config.get("severity_mapping", {}) or {}

        logger.info(
            "✅ 已加载规则配置: %s (规则: %d, 资金权重: %d)",
            self.config_path,
            len(self._category_config),
            len(self.fund_impact_weights),
        )

    def _apply_config_to_rules(self) -> None:
        """将配置应用到内置规则(例如覆盖严重性)"""
        for rule in self.rules:
            cfg = self._category_config.get(rule.category)
            if not cfg:
                continue
            severity = cfg.get("severity")
            if severity:
                rule.severity = str(severity).upper()

    # ------------------------------------------------------------------ #
    # 内置规则
    # ------------------------------------------------------------------ #
    def _load_builtin_rules(self) -> None:
        """加载内置规则"""
        # 1. 重入攻击
        self.rules.append(
            VulnerabilityRule(
                category=VulnerabilityCategory.REENTRANCY,
                name="经典重入",
                description="外部调用后修改状态,可被重入攻击",
                fund_impact=FundImpact.CRITICAL,
                severity="HIGH",
                patterns=["call", "transfer", "send", "delegatecall"],
                exclusions=["nonReentrant", "ReentrancyGuard"],
                requires_external_call=True,
                requires_state_change=True,
                recommendation="使用checks-effects-interactions模式或ReentrancyGuard",
            )
        )

        # 2. tx.origin认证
        self.rules.append(
            VulnerabilityRule(
                category=VulnerabilityCategory.TX_ORIGIN,
                name="tx.origin权限检查",
                description="使用tx.origin进行权限验证可被钓鱼攻击",
                fund_impact=FundImpact.HIGH,
                severity="HIGH",
                patterns=["tx.origin", "require", "=="],
                exclusions=[],
                recommendation="使用msg.sender替代tx.origin",
                reference="https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/tx-origin/",
            )
        )

        # 3. delegatecall漏洞
        self.rules.append(
            VulnerabilityRule(
                category=VulnerabilityCategory.DELEGATECALL,
                name="不受控delegatecall",
                description="delegatecall目标地址可被用户控制",
                fund_impact=FundImpact.CRITICAL,
                severity="HIGH",
                patterns=["delegatecall"],
                exclusions=["onlyOwner", "whitelist"],
                recommendation="严格限制delegatecall目标地址,使用白名单",
                custom_detector=lambda ctx: "delegatecall"
                in ctx.get("code", "")
                and "msg.sender" in ctx.get("params", []),
            )
        )

        # 4. selfdestruct滥用
        self.rules.append(
            VulnerabilityRule(
                category=VulnerabilityCategory.SELFDESTRUCT,
                name="无保护自毁",
                description="selfdestruct未做权限控制",
                fund_impact=FundImpact.CRITICAL,
                severity="HIGH",
                patterns=["selfdestruct", "suicide"],
                exclusions=["onlyOwner", "require"],
                requires_value_transfer=True,
                recommendation="添加onlyOwner修饰符",
                reference="https://swcregistry.io/docs/SWC-106",
            )
        )

        # 5. 未保护初始化
        self.rules.append(
            VulnerabilityRule(
                category=VulnerabilityCategory.UNPROTECTED_INITIALIZATION,
                name="初始化函数未保护",
                description="initialize/init函数缺少初始化检查",
                fund_impact=FundImpact.HIGH,
                severity="HIGH",
                patterns=["initialize", "init", "setup"],
                exclusions=["initializer", "onlyOnce", "initialized"],
                recommendation="使用OpenZeppelin的Initializable或添加初始化标志",
                reference="https://docs.openzeppelin.com/upgrades-plugins/writing-upgradeable",
            )
        )

        # 6. 抢跑攻击
        self.rules.append(
            VulnerabilityRule(
                category=VulnerabilityCategory.FRONT_RUNNING,
                name="交易顺序依赖",
                description="函数执行依赖交易顺序,可被抢跑",
                fund_impact=FundImpact.MEDIUM,
                severity="MEDIUM",
                patterns=["block.timestamp", "price", "swap"],
                exclusions=["deadline", "minReturn"],
                recommendation="添加滑点保护和deadline参数",
                reference="https://consensys.github.io/smart-contract-best-practices/attacks/frontrunning/",
            )
        )

    # ------------------------------------------------------------------ #
    # 规则查询 & 资金影响辅助
    # ------------------------------------------------------------------ #
    def _is_rule_enabled(self, rule: VulnerabilityRule) -> bool:
        """根据配置判断规则是否启用"""
        cfg = self._category_config.get(rule.category)
        if not cfg:
            return True
        return bool(cfg.get("enabled", True))

    def get_rule_priority(self, category: VulnerabilityCategory) -> int:
        """获取规则优先级,用于置信度加权"""
        cfg = self._category_config.get(category) or {}
        try:
            return int(cfg.get("priority", 0))
        except (TypeError, ValueError):
            return 0

    def get_fund_impact_weight(self, impact: FundImpact) -> float:
        """返回资金影响权重(若未配置则使用合理默认值)"""
        if self.fund_impact_weights:
            return self.fund_impact_weights.get(impact, 0.0)

        # 默认权重,与示例 YAML 保持一致
        default_weights: Dict[FundImpact, float] = {
            FundImpact.CRITICAL: 10.0,
            FundImpact.HIGH: 7.0,
            FundImpact.MEDIUM: 4.0,
            FundImpact.LOW: 2.0,
            FundImpact.NONE: 0.0,
        }
        return default_weights.get(impact, 0.0)

    def map_fund_impact_to_severity(self, impact: FundImpact) -> str:
        """根据资金影响映射严重性级别"""
        if self.severity_mapping:
            key = f"{impact.name}_FUND_IMPACT"
            # 默认回退为 LOW, 避免配置缺失导致异常
            return str(self.severity_mapping.get(key, "LOW")).upper()

        # 默认映射
        mapping: Dict[FundImpact, str] = {
            FundImpact.CRITICAL: "HIGH",
            FundImpact.HIGH: "HIGH",
            FundImpact.MEDIUM: "MEDIUM",
            FundImpact.LOW: "LOW",
            FundImpact.NONE: "LOW",
        }
        return mapping.get(impact, "LOW")

    # ------------------------------------------------------------------ #
    # 规则匹配 & 资金影响分析
    # ------------------------------------------------------------------ #
    def add_rule(self, rule: VulnerabilityRule) -> None:
        """添加自定义规则"""
        self.rules.append(rule)

    def match_rules(self, context: Dict[str, Any]) -> List[VulnerabilityRule]:
        """匹配适用规则"""
        matched: List[VulnerabilityRule] = []
        code = context.get("code", "").lower()

        for rule in self.rules:
            if not self._is_rule_enabled(rule):
                continue

            # 检查模式匹配
            has_pattern = any(p.lower() in code for p in rule.patterns)
            has_exclusion = any(e.lower() in code for e in rule.exclusions)

            if not has_pattern or has_exclusion:
                continue

            # 检查上下文要求
            if rule.requires_external_call and not context.get("has_external_call"):
                continue
            if rule.requires_state_change and not context.get("has_state_change"):
                continue
            if rule.requires_value_transfer and not context.get("has_value_transfer"):
                continue

            # 自定义检测
            if rule.custom_detector and not rule.custom_detector(context):
                continue

            matched.append(rule)

        return matched

    def analyze_fund_impact(self, code: str, function_name: str) -> FundImpact:
        """分析资金影响程度"""
        code_lower = code.lower()

        # CRITICAL: 直接转账/提现
        if any(kw in code_lower for kw in ["transfer(", "send(", "call{value", "withdraw"]):
            if any(kw in code_lower for kw in ["msg.sender", "to", "recipient"]):
                return FundImpact.CRITICAL

        # HIGH: 授权/批准
        if any(kw in code_lower for kw in ["approve", "allowance", "mint"]):
            return FundImpact.HIGH

        # MEDIUM: 价格/余额计算
        if any(kw in code_lower for kw in ["balanceof", "price", "rate", "amount"]):
            return FundImpact.MEDIUM

        # LOW: 配置/参数修改
        if any(kw in code_lower for kw in ["set", "update", "config"]):
            return FundImpact.LOW

        return FundImpact.NONE
