# Phase 3.2: monitor_positions æ‹†åˆ†é‡æ„è®¡åˆ’

**æ—¥æœŸ**: 2025-01-26
**ç›®æ ‡**: å°†1067è¡Œçš„`monitor_positions`å‡½æ•°æ‹†åˆ†ä¸ºå¯ç»´æŠ¤çš„æ¨¡å—åŒ–ä»£ç 
**é£é™©**: ä¸­ç­‰ (ä¸šåŠ¡é€»è¾‘å¤æ‚,æ¶‰åŠäº¤æ˜“æ‰§è¡Œ)

---

## ğŸ“Š ç°çŠ¶åˆ†æ

### å½“å‰ä»£ç ç»“æ„ (line 937-2004)

```
monitor_positions() {
    loop {
        sleep 3åˆ†é’Ÿ

        // å®šæ—¶æ¸…ç†ä»»åŠ¡
        - triggerè®¢å•ç›‘æ§ (line 954-959)
        - å†…å­˜æ¸…ç† (line 962-968)
        - å­¤ç«‹è®¢å•æ¸…ç† (line 971-976)

        // ç”Ÿæˆå¿«ç…§
        - åˆ›å»ºposition_trackerså¿«ç…§ (line 991-1013)

        // é˜¶æ®µ1: è¯•æ¢æŒä»“è¡¥ä»“æ£€æµ‹ (line 1018-1304) - ~286è¡Œ
        {
            - è·å–trial_positionsåˆ—è¡¨
            - å¾ªç¯æ¯ä¸ªsymbol
            - è·å–å¤šå‘¨æœŸKçº¿ (1m,5m,15m,1h)
            - æ£€æµ‹å¯åŠ¨ä¿¡å·
            - æ‰§è¡Œ70%è¡¥ä»“
            - åŒæ­¥trackeræ•°é‡
        }

        // é˜¶æ®µ2: åˆ†æ‰¹æŒä»“å¿«é€Ÿæ­¢æŸ (line 1309-1520) - ~211è¡Œ
        {
            - è·å–all_positionsåˆ—è¡¨
            - å¾ªç¯æ¯ä¸ªsymbol
            - æ£€æŸ¥å¿«é€Ÿæ­¢æŸè§„åˆ™
            - æ‰§è¡ŒAIè¯„ä¼° (å¯é€‰)
            - æ‰§è¡Œå¹³ä»“
        }

        // é˜¶æ®µ3: æ—§position_trackersæŒä»“å¤„ç† (line 1527-1764) - ~237è¡Œ
        {
            - è·å–exchange_positions
            - æ‰¹é‡æ”¶é›†è¡Œæƒ…ä¸Šä¸‹æ–‡
            - æ‰¹é‡AIè¯„ä¼°
            - ç”Ÿæˆactions_to_execute
        }

        // é˜¶æ®µ4: æ‰§è¡ŒæŒä»“æ“ä½œ (line 1770-2002) - ~232è¡Œ
        {
            - å…¨éƒ¨å¹³ä»“å¤„ç†
            - éƒ¨åˆ†å¹³ä»“å¤„ç† (ç­‰å¾…è®¢å•å®Œæˆ)
            - é™ä»·æ­¢ç›ˆè®¾ç½®
            - trackeræ›´æ–°
        }
    }
}
```

---

## âœ… é‡‡ç”¨ç­–ç•¥: **è¾…åŠ©å‡½æ•°æå–æ³•**

**ç†ç”±**:
1. ä¸»å¾ªç¯ç»“æ„å·²ç»æ¸…æ™°: å®šæ—¶æ¸…ç† â†’ å¿«ç…§ â†’ 4ä¸ªé˜¶æ®µå¤„ç†
2. æ¯ä¸ªé˜¶æ®µå†…éƒ¨å·²ç»ç›¸å¯¹ç‹¬ç«‹
3. æå–è¾…åŠ©å‡½æ•°æ¯”å®Œå…¨é‡æ„æ›´å®‰å…¨

**æ–¹æ¡ˆ**:
- ä¿ç•™ä¸»å¾ªç¯ç»“æ„ä¸å˜
- å°†4ä¸ªé˜¶æ®µå†…éƒ¨é€»è¾‘æå–ä¸ºç§æœ‰è¾…åŠ©å‡½æ•°
- ç¡®ä¿å‚æ•°ä¼ é€’æ¸…æ™°,æ— å‰¯ä½œç”¨å†²çª

---

## ğŸ”§ æ‹†åˆ†æ­¥éª¤

### Step 1: è¯•æ¢æŒä»“è¡¥ä»“æ£€æµ‹

**æå–å‡½æ•°**:
```rust
async fn check_trial_positions_and_add(&self) -> () {
    // line 1018-1304ä»£ç 
}
```

**è°ƒç”¨**:
```rust
self.check_trial_positions_and_add().await;
```

---

### Step 2: åˆ†æ‰¹æŒä»“å¿«é€Ÿæ­¢æŸ

**æå–å‡½æ•°**:
```rust
async fn check_staged_positions_stop_loss(&self) -> () {
    // line 1309-1520ä»£ç 
}
```

**è°ƒç”¨**:
```rust
self.check_staged_positions_stop_loss().await;
```

---

### Step 3: AIæ‰¹é‡è¯„ä¼°æŒä»“

**æå–å‡½æ•°**:
```rust
async fn evaluate_positions_with_ai(
    &self,
    tracker_snapshots: &HashMap<String, TrackerSnapshot>,
) -> Vec<PositionAction> {
    // line 1527-1764ä»£ç 
    // è¿”å›actions_to_execute
}
```

**è°ƒç”¨**:
```rust
let actions_to_execute = self.evaluate_positions_with_ai(&tracker_snapshots).await;
```

---

### Step 4: æ‰§è¡ŒæŒä»“æ“ä½œ

**æå–å‡½æ•°**:
```rust
async fn execute_position_actions(&self, actions: Vec<PositionAction>) -> () {
    // line 1770-2002ä»£ç 
}
```

**è°ƒç”¨**:
```rust
self.execute_position_actions(actions_to_execute).await;
```

---

## ğŸ“‹ é‡æ„åçš„ä¸»å‡½æ•°ç»“æ„

```rust
async fn monitor_positions(self: Arc<Self>) {
    info!("ğŸ” æŒä»“ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨");

    let mut cleanup_counter = 0;
    let mut trigger_monitor_counter = 0;
    let mut orphaned_order_cleanup_counter = 0;

    loop {
        tokio::time::sleep(tokio::time::Duration::from_secs(POSITION_CHECK_INTERVAL_SECS)).await;

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // å®šæ—¶æ¸…ç†ä»»åŠ¡
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        cleanup_counter += 1;
        trigger_monitor_counter += 1;
        orphaned_order_cleanup_counter += 1;

        if trigger_monitor_counter >= 2 {
            self.monitor_trigger_orders().await?;
            trigger_monitor_counter = 0;
        }

        if cleanup_counter >= 12 {
            info!("â° å¼€å§‹æ‰§è¡Œå®šæœŸå†…å­˜æ¸…ç†...");
            self.cleanup_tracked_coins().await;
            self.cleanup_orphaned_trackers().await;
            cleanup_counter = 0;
        }

        if orphaned_order_cleanup_counter >= 10 {
            self.cleanup_orphaned_trigger_orders().await?;
            orphaned_order_cleanup_counter = 0;
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // ç”Ÿæˆposition_trackerså¿«ç…§
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        let tracker_snapshots = self.snapshot_position_trackers().await;

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // é˜¶æ®µ1: è¯•æ¢æŒä»“è¡¥ä»“æ£€æµ‹
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        self.check_trial_positions_and_add().await;

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // é˜¶æ®µ2: åˆ†æ‰¹æŒä»“å¿«é€Ÿæ­¢æŸ
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        self.check_staged_positions_stop_loss().await;

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // é˜¶æ®µ3: AIæ‰¹é‡è¯„ä¼°æŒä»“
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        let actions_to_execute = self.evaluate_positions_with_ai(&tracker_snapshots).await;

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // é˜¶æ®µ4: æ‰§è¡ŒæŒä»“æ“ä½œ
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        self.execute_position_actions(actions_to_execute).await;
    }
}
```

**ä»£ç è¡Œæ•°å¯¹æ¯”**:
- é‡æ„å‰: 1067è¡Œ
- é‡æ„å: ~150è¡Œä¸»å‡½æ•° + 4ä¸ªè¾…åŠ©å‡½æ•°
- å¯è¯»æ€§æå‡: â­â­â­â­â­

---

## âš ï¸ é£é™©æ§åˆ¶

1. **ä¿ç•™åŸå§‹é€»è¾‘** - è¾…åŠ©å‡½æ•°æ˜¯åŸåœ°æå–,ä¸ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
2. **å‚æ•°ä¸å˜** - æ‰€æœ‰å‡½æ•°è®¿é—®`self`,æ— éœ€å¤æ‚å‚æ•°ä¼ é€’
3. **é€æ­¥ç¼–è¯‘** - æ¯æå–ä¸€ä¸ªå‡½æ•°,ç«‹å³ç¼–è¯‘éªŒè¯
4. **ä¸šåŠ¡ä¸å˜** - ä¿è¯Binance APIè°ƒç”¨é¡ºåºä¸å˜

---

## âœ… éªŒè¯æ¸…å•

- [ ] `cargo build --release` ç¼–è¯‘é€šè¿‡
- [ ] æ‰€æœ‰Clippyè­¦å‘Šä¿æŒåŸçŠ¶(<10ä¸ªæ–°å¢)
- [ ] `monitor_positions`ä¸»å‡½æ•° <200è¡Œ
- [ ] 4ä¸ªè¾…åŠ©å‡½æ•°ç‹¬ç«‹å¯æµ‹è¯•
- [ ] Git commitè®°å½•é‡æ„æ­¥éª¤

---

**ä¸‹ä¸€æ­¥**: å¼€å§‹æ‰§è¡Œ Step 1,æå–è¯•æ¢æŒä»“è¡¥ä»“æ£€æµ‹é€»è¾‘
