# 🔄 Position Rebalance Trader - 流程图

## 🎯 系统总览

```
┌─────────────────────────────────────────────────────────────────┐
│           Position Rebalance Trader (双线程系统)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  线程1: Telegram监听 ──→ 币种解析 ──→ 信号入队                     │
│                                                                   │
│  线程2: 每3分钟 ──→ AI批量分析 ──→ 仓位调整 ──→ 交易执行           │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 📡 线程1：Telegram 频道监听

```
┌──────────────────────────────────────────────────────────────┐
│                     Telegram 监听线程                          │
└──────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌──────────────────────────────────────────────────────────────┐
│  grammers_client.next_update()                               │
│  监听频道: Valuescan主力资金监控 (ID: 2254462672)              │
└──────────────────────────────────────────────────────────────┘
                            │
                            ↓
                   ┌────────┴────────┐
                   │  收到新消息？    │
                   └────────┬────────┘
                            │ Yes
                            ↓
┌──────────────────────────────────────────────────────────────┐
│  CoinParser.parse_to_signal()                                │
│  解析币种：BTC、ETH、SOL 等                                   │
│  提取信息：symbol, source, timestamp                          │
└──────────────────────────────────────────────────────────────┘
                            │
                            ↓
                   ┌────────┴────────┐
                   │  解析成功？      │
                   └────────┬────────┘
                            │ Yes
                            ↓
┌──────────────────────────────────────────────────────────────┐
│  SignalManager.add_signals()                                 │
│  • 去重检查 (3分钟窗口)                                       │
│  • 添加到队列                                                 │
│  • 设置过期时间 (10分钟)                                      │
└──────────────────────────────────────────────────────────────┘
                            │
                            ↓
                    ┌───────┴───────┐
                    │  等待下一条   │
                    │   消息...     │
                    └───────────────┘
```

## ⏰ 线程2：定时仓位重估（每3分钟）

```
┌──────────────────────────────────────────────────────────────┐
│              定时评估线程 (tokio::time::interval)             │
│                     间隔: 180 秒                              │
└──────────────────────────────────────────────────────────────┘
                            │
                            ↓
                    ┌───────┴───────┐
                    │   3分钟到？   │
                    └───────┬───────┘
                            │ Yes
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  STEP 1: 同步持仓状态                         │
├─────────────────────────────────────────────────────────────┤
│  • BinanceClient.get_positions()                            │
│  • 获取所有当前持仓                                          │
│  • PositionCoordinator.sync_positions()                     │
│  • 重置周期计数器                                            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  STEP 2: 收集新信号                          │
├─────────────────────────────────────────────────────────────┤
│  • SignalManager.drain_recent(180秒)                        │
│  • 获取最近3分钟的所有信号                                   │
│  • 自动去重                                                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  STEP 3: 合并币种列表                        │
├─────────────────────────────────────────────────────────────┤
│  symbols = 新信号币种 ∪ 持仓币种                             │
│  去重后统一分析                                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
                   ┌────────┴────────┐
                   │  有币种需要     │
                   │   分析吗？      │
                   └────────┬────────┘
                            │ Yes
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  STEP 4: AI 批量分析                         │
├─────────────────────────────────────────────────────────────┤
│  AiDecisionEngine.analyze_batch()                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  对每个币种并发执行 (最多5个并发):                   │   │
│  │                                                       │   │
│  │  1. get_klines_cached()                              │   │
│  │     └─ 获取100根1h K线 (带15分钟缓存)                │   │
│  │                                                       │   │
│  │  2. TechnicalAnalyzer.calculate_indicators()         │   │
│  │     ├─ BOLL (布林带)                                 │   │
│  │     ├─ RSI (相对强弱)                                │   │
│  │     ├─ MACD (趋势)                                   │   │
│  │     └─ SMA (均线: 5/20/50)                           │   │
│  │                                                       │   │
│  │  3. DeepSeekClient.build_prompt()                    │   │
│  │     └─ 构建分析 prompt (K线 + 指标 + 持仓)           │   │
│  │                                                       │   │
│  │  4. DeepSeekClient.analyze_market()                  │   │
│  │     └─ 调用 DeepSeek AI                              │   │
│  │                                                       │   │
│  │  返回: {                                              │   │
│  │    signal: "BUY" | "SELL" | "HOLD",                  │   │
│  │    confidence: "HIGH" | "MEDIUM" | "LOW",            │   │
│  │    stop_loss: 64500.0,                               │   │
│  │    take_profit: 67000.0,                             │   │
│  │    reason: "突破关键位，趋势强劲"                      │   │
│  │  }                                                    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  STEP 5: 仓位协调                            │
├─────────────────────────────────────────────────────────────┤
│  PositionCoordinator.merge_decisions_to_plan()              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  对每个AI决策:                                       │   │
│  │                                                       │   │
│  │  1. 检查冷却期 (5分钟)                              │   │
│  │     └─ 冷却中 → 跳过                                │   │
│  │                                                       │   │
│  │  2. 检查调整次数 (单周期最多2次)                    │   │
│  │     └─ 超限 → 跳过                                  │   │
│  │                                                       │   │
│  │  3. 检测冲突类型:                                    │   │
│  │     ├─ NoPosition: 无持仓 → 开仓                    │   │
│  │     ├─ SameDirection: 同向 → 加仓/持有              │   │
│  │     └─ OppositeDirection: 反向 → 平仓/反手          │   │
│  │                                                       │   │
│  │  4. 生成交易动作:                                    │   │
│  │     ├─ OpenLong/OpenShort (开仓)                    │   │
│  │     ├─ CloseLong/CloseShort (平仓)                  │   │
│  │     ├─ AddLong/AddShort (加仓)                      │   │
│  │     ├─ ReduceLong/ReduceShort (减仓)                │   │
│  │     ├─ ReverseToLong/ReverseToShort (反向)          │   │
│  │     └─ Hold (持有)                                   │   │
│  │                                                       │   │
│  │  5. 设置优先级:                                      │   │
│  │     Emergency (3) > High (2) > Medium (1) > Low (0)  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  返回: 按优先级排序的交易动作列表                             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
                   ┌────────┴────────┐
                   │  有需要执行的   │
                   │   动作吗？      │
                   └────────┬────────┘
                            │ Yes
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  STEP 6: 交易执行                            │
├─────────────────────────────────────────────────────────────┤
│  TradeExecutor.execute_plan()                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  对每个交易动作:                                     │   │
│  │                                                       │   │
│  │  1. 等待 API 速率限制 (500ms)                       │   │
│  │                                                       │   │
│  │  2. 根据动作类型调用对应 API:                        │   │
│  │     ├─ OpenLong → BinanceClient.open_long()         │   │
│  │     ├─ OpenShort → BinanceClient.open_short()       │   │
│  │     ├─ Close → BinanceClient.close_position()       │   │
│  │     └─ ...                                           │   │
│  │                                                       │   │
│  │  3. 记录执行结果:                                    │   │
│  │     ├─ success: true/false                           │   │
│  │     ├─ order_id: "12345678"                          │   │
│  │     ├─ executed_price: 65000.0                       │   │
│  │     └─ error_message: null | "余额不足"              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  返回: (执行结果列表, 统计信息)                               │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  STEP 7: 状态同步                            │
├─────────────────────────────────────────────────────────────┤
│  对每个成功执行的币种:                                       │
│  • BinanceClient.get_positions() (再次获取)                 │
│  • PositionCoordinator.update_position_after_trade()        │
│  • 更新持仓状态                                              │
│  • 设置冷却期: 当前时间 + 5分钟                              │
│  • 增加调整计数                                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
                    ┌───────┴───────┐
                    │  记录日志     │
                    │  等待下一轮   │
                    │  (3分钟后)    │
                    └───────────────┘
```

## 🔄 完整流程时间线

```
时间轴示例 (假设从 21:30:00 开始)

21:30:00  ┌─ 线程1: 收到 Telegram 消息 "BTC突破$65000"
21:30:01  │  └─ 解析: BTCUSDT → 信号入队
          │
21:30:05  ├─ 线程1: 收到消息 "ETH上涨5%"
21:30:06  │  └─ 解析: ETHUSDT → 信号入队
          │
21:30:15  ├─ 线程1: 收到消息 "SOL主力流入"
21:30:16  │  └─ 解析: SOLUSDT → 信号入队
          │
          │  [线程1 持续监听...]
          │
21:33:00  ├─ 线程2: ⏰ 3分钟到，开始评估
21:33:01  │  └─ STEP 1: 同步持仓 (BTCUSDT多单, ETHUSDT多单)
21:33:02  │  └─ STEP 2: 收集信号 (BTC, ETH, SOL)
21:33:03  │  └─ STEP 3: 合并币种 (BTC, ETH, SOL) - 3个币种
21:33:04  │
21:33:05  ├─ STEP 4: AI批量分析开始
          │  ├─ [并发] BTCUSDT 分析中...
          │  ├─ [并发] ETHUSDT 分析中...
          │  └─ [并发] SOLUSDT 分析中...
21:33:08  │  ├─ ✅ BTC 完成: BUY (HIGH)
21:33:09  │  ├─ ✅ ETH 完成: HOLD (MEDIUM)
21:33:10  │  └─ ✅ SOL 完成: BUY (HIGH)
          │
21:33:11  ├─ STEP 5: 仓位协调
          │  ├─ BTC: 已有多单 + BUY信号 → AddLong (加仓)
          │  ├─ ETH: 已有多单 + HOLD信号 → Hold (持有)
          │  └─ SOL: 无持仓 + BUY信号 → OpenLong (开多)
          │  
          │  生成计划: [AddLong BTC, OpenLong SOL]
          │
21:33:12  ├─ STEP 6: 交易执行
21:33:13  │  ├─ [1/2] AddLong BTCUSDT 6 USDT @ 65000 → ✅ 成功
21:33:14  │  └─ [等待 500ms...]
21:33:15  │  └─ [2/2] OpenLong SOLUSDT 6 USDT @ 142.5 → ✅ 成功
          │
21:33:16  ├─ STEP 7: 状态同步
          │  ├─ 获取最新持仓
          │  ├─ BTC: 设置冷却至 21:38:16
          │  └─ SOL: 设置冷却至 21:38:16
          │
21:33:17  └─ ✅ 本轮评估结束
          
          [等待下一轮...]
          
21:36:00  ┌─ 线程2: ⏰ 下一轮评估开始
          │  └─ 检查冷却期: BTC和SOL还在冷却中，跳过
          ...
```

## 🧩 核心模块关系图

```
┌─────────────────────────────────────────────────────────────┐
│                    主程序 (main)                             │
└────────────┬───────────────────────────────┬────────────────┘
             │                               │
             ↓                               ↓
    ┌────────────────┐              ┌────────────────┐
    │   线程1        │              │   线程2        │
    │ Telegram监听   │              │  定时评估      │
    └────────┬───────┘              └───────┬────────┘
             │                              │
             │                              │
    ┌────────▼───────┐              ┌──────▼─────────┐
    │ CoinParser     │              │ SignalManager  │
    │ (币种解析)     │◄─────────────│ (信号管理)     │
    └────────┬───────┘              └───────┬────────┘
             │                              │
             │                              │
             │                       ┌──────▼─────────────┐
             │                       │ AiDecisionEngine   │
             │                       │ (AI决策引擎)       │
             │                       └──────┬─────────────┘
             │                              │
             │                              │
             │                       ┌──────▼──────────────┐
             │                       │ DeepSeekClient     │
             │                       │ (AI API)           │
             │                       └──────┬──────────────┘
             │                              │
             │                       ┌──────▼──────────────┐
             │                       │ TechnicalAnalyzer  │
             │                       │ (技术指标)          │
             │                       └──────┬──────────────┘
             │                              │
             │                       ┌──────▼───────────────┐
             │                       │ PositionCoordinator │
             │                       │ (仓位协调)           │
             │                       └──────┬───────────────┘
             │                              │
             │                       ┌──────▼────────────┐
             │                       │ TradeExecutor     │
             │                       │ (交易执行)         │
             │                       └──────┬────────────┘
             │                              │
             └──────────────┬───────────────┘
                            │
                     ┌──────▼──────────┐
                     │ BinanceClient   │
                     │ (交易所API)     │
                     └─────────────────┘
```

## 📊 数据流向图

```
Telegram频道
    │
    │ 新消息
    ↓
[CoinParser]
    │
    │ CoinSignal
    ↓
[SignalManager]
    │
    │ 3分钟后
    ↓
[收集信号] ←──┐
    │          │
    │ symbols  │
    ↓          │
[AI分析]      │ symbols
    │          │
    │ decisions│
    ↓          │
[仓位协调] ───┘
    │
    │ actions
    ↓
[交易执行]
    │
    │ results
    ↓
[状态同步]
```

## 🎯 关键特性总结

### ✅ 并发处理
- 线程1 和 线程2 独立运行
- AI 批量分析支持最多 5 个并发
- 使用 `tokio::spawn` 异步任务

### ✅ 智能去重
- 3分钟时间窗口去重
- 防止重复信号干扰
- 自动清理过期信号

### ✅ 缓存优化
- K线数据缓存 15 分钟
- 减少API调用次数
- 提升响应速度

### ✅ 风险控制
- 冷却期机制（5分钟）
- 调整次数限制（单周期2次）
- 优先级排序（紧急止损优先）
- API速率限制（500ms间隔）

### ✅ 容错处理
- AI 调用失败自动重试 3 次
- 超时保护（10秒）
- 错误日志记录
- 程序不会因单个错误崩溃

## 🚀 快速启动

```bash
# 方式1：使用启动脚本（推荐）
cd /home/hanins/code/web3/apps/rust-trading-bot
./scripts/run_rebalance_trader.sh

# 方式2：直接运行
cargo run --bin position_rebalance_trader

# 方式3：Release模式
cargo build --release --bin position_rebalance_trader
./target/release/position_rebalance_trader
```

## 📚 相关文档

- [详细使用指南](REBALANCE_TRADER_GUIDE.md)
- [环境变量配置](.env.example)
- [DeepSeek AI文档](docs/deepseek/DEEPSEEK_TRADER_README.md)
