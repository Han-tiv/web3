# 分批建仓 + 启动补仓策略 (Staged Entry Strategy)

## 核心理念

**目标**: 降低试错成本 + 优化入场精度 + 提高盈亏比

**关键洞察**:
1. **Valuescan信号 ≠ 最佳入场时机** (可能在震荡高点)
2. **1h K线分析 → 找到主力成本区** (长下影线集中区域)
3. **小仓位试探 (30%) → 启动确认补仓 (70%)** (降低试错成本)
4. **多周期综合分析** (1m实时 + 5m信号 + 15m趋势 + 1h关键位)

---

## 一、开仓策略 (1h主入场区 + 15m辅助入场区)

### 1.1 当前问题

**❌ 旧方案: Valuescan信号 → 立即满仓**
```
问题:
├─ Valuescan可能在震荡高点发出信号
├─ 一次性满仓,判断错误立即-2%止损
└─ 没有考虑1h级别的支撑/阻力位

示例:
Valuescan信号 @ $0.495 (1h高点$0.50附近)
→ 满仓建仓 @ $0.495
→ 价格回调到$0.485 (-2%)
→ 触发止损,亏损-2%
```

---

### 1.2 新方案: 1h主入场区 + 15m辅助入场区 (双重确认)

**核心理念**:
- **1h K线 (主入场区)**: 识别主力成本区,决定整体入场方向
- **15m K线 (辅助入场区)**: 精细化入场时机,优化入场价格

**为什么需要15m辅助?**
```
1h局限性:
├─ 反应慢: 1小时才形成1根K线
├─ 等待久: 可能要等很久才回调到1h成本区
└─ 不够细: 看不到短期15分钟级别的支撑/阻力

15m优势:
├─ 更精细: 15分钟就能看到价格行为
├─ 更灵活: 提供备选入场点,不错过机会
└─ 更安全: 1h破位后,15m可能形成新支撑
```

---

**✅ 分析流程**:

#### 步骤1: 接收Valuescan信号
```
Valuescan发出信号: PONDUSDT 主力资金异动
当前价格: $0.495
```

#### 步骤2A: 分析1h K线 → 主入场区 (最近5-8根)
```rust
// 伪代码
fn analyze_1h_entry_zone(klines_1h: &[Kline]) -> EntryZone {
    let recent_8h = klines_1h.iter().rev().take(8);

    // 1. 找到最近8小时的价格区间
    let lowest = recent_8h.map(|k| k.low).min();   // $0.46
    let highest = recent_8h.map(|k| k.high).max(); // $0.50

    // 2. 识别长下影线集中区(主力成本区)
    let shadow_zones = find_long_shadow_zones(recent_8h);
    // 结果: $0.47 - $0.485区域有3根1h K线的长下影线

    // 3. 识别平台支撑位
    let platform_support = find_platform_support(recent_8h);
    // 结果: $0.48附近有2小时的横盘平台

    // 4. 计算主力成本区中位数
    let entry_zone_center = (shadow_zones.low + shadow_zones.high) / 2.0;
    // 结果: ($0.47 + $0.485) / 2 = $0.4775

    EntryZone {
        ideal_entry: entry_zone_center,  // $0.4775
        entry_range: ($0.47, $0.485),    // 可接受范围
        stop_loss: lowest * 0.985,       // $0.453 (-5% from ideal)
        current_price: $0.495,           // Valuescan信号价格
        position_in_range: "NEAR_HIGH",  // 当前在区间高位
        confidence: HIGH,                // 1h级别置信度高
        suggested_position: 30%,         // 建议仓位
    }
}
```

#### 步骤2B: 分析15m K线 → 辅助入场区 (最近20-30根,即5-7.5小时)
```rust
fn analyze_15m_entry_zone(klines_15m: &[Kline], klines_1h_zone: &EntryZone) -> EntryZone {
    let recent_30_bars = klines_15m.iter().rev().take(30);

    // 1. 找到最近5-7.5小时的价格区间
    let lowest = recent_30_bars.map(|k| k.low).min();   // $0.475
    let highest = recent_30_bars.map(|k| k.high).max(); // $0.498

    // 2. 识别15m平台支撑(连续3根以上横盘)
    let platform_zones = find_15m_platform_support(recent_30_bars);
    // 结果: $0.478 - $0.487区域有4根15m K线横盘

    // 3. 识别15m下影线集中区(下影>1.5%)
    let shadow_zones = find_15m_shadow_cluster(recent_30_bars);
    // 结果: $0.480附近有3根15m长下影线

    // 4. 计算15m MA支撑
    let sma_20 = calculate_sma(&klines_15m, 20);  // $0.482
    let sma_50 = calculate_sma(&klines_15m, 50);  // $0.478

    // 5. 综合计算15m入场区
    let entry_zone_center = (shadow_zones.low + platform_zones.high) / 2.0;
    // 结果: ($0.478 + $0.487) / 2 = $0.4825

    // 6. 判断15m与1h的关系
    let relationship = if entry_zone_center >= klines_1h_zone.entry_range.0
                          && entry_zone_center <= klines_1h_zone.entry_range.1 {
        "15M_INSIDE_1H"  // 15m在1h内,完美共振
    } else if entry_zone_center > klines_1h_zone.entry_range.1 {
        "15M_ABOVE_1H"   // 15m在1h上方,备选方案
    } else {
        "15M_BELOW_1H"   // 15m在1h下方,可能是破位重建
    };

    EntryZone {
        ideal_entry: entry_zone_center,  // $0.4825
        entry_range: ($0.478, $0.487),   // 15m入场区
        stop_loss: lowest * 0.985,       // $0.468 (-3% from ideal)
        current_price: $0.495,
        position_in_range: "ABOVE_RANGE", // 当前在区间上方
        confidence: MEDIUM,               // 15m级别置信度中等
        suggested_position: 20%,          // 建议仓位(比1h低)
        relationship: relationship,       // 与1h的关系
    }
}
```

#### 步骤3: 综合决策 - 主辅入场区优先级
```rust
fn decide_entry_strategy(
    zone_1h: &EntryZone,
    zone_15m: &EntryZone,
    current_price: f64
) -> EntryDecision {

    // 情况1: 当前价在1h主入场区内
    if current_price >= zone_1h.entry_range.0 && current_price <= zone_1h.entry_range.1 {
        // 进一步检查15m
        if zone_15m.relationship == "15M_INSIDE_1H" {
            // 1h+15m共振,优先在15m区间下沿入场
            return EntryDecision {
                action: "ENTER_NOW",
                price: zone_15m.entry_range.0.max(current_price),  // $0.478或当前价
                position: 30%,
                stop_loss: zone_1h.stop_loss,  // 使用1h止损(更宽)
                reason: "1h主区内 + 15m共振,立即建仓",
            };
        } else {
            // 1h区内但15m不共振,使用1h区间
            return EntryDecision {
                action: "ENTER_NOW",
                price: current_price,
                position: 30%,
                stop_loss: zone_1h.stop_loss,
                reason: "1h主区内,立即建仓",
            };
        }
    }

    // 情况2: 当前价在1h主入场区上方
    if current_price > zone_1h.entry_range.1 {
        // 检查15m是否提供备选入场点
        if zone_15m.relationship == "15M_ABOVE_1H"
           && current_price >= zone_15m.entry_range.0
           && current_price <= zone_15m.entry_range.1 {
            // 15m在1h上方提供备选入场点
            return EntryDecision {
                action: "ENTER_WITH_CAUTION",
                price: zone_15m.entry_range.0,  // 15m下沿
                position: 20%,  // 降低仓位(风险高)
                stop_loss: zone_15m.stop_loss,  // 使用15m止损(更紧)
                reason: "1h主区上方,15m备选入场点",
            };
        } else {
            // 等待回调到1h主区
            return EntryDecision {
                action: "WAIT_FOR_PULLBACK",
                price: zone_1h.entry_range.1,  // 挂限价单在1h上沿
                position: 30%,
                stop_loss: zone_1h.stop_loss,
                reason: "等待回调到1h主区",
            };
        }
    }

    // 情况3: 当前价在1h主入场区下方
    if current_price < zone_1h.entry_range.0 {
        // 1h破位,检查15m是否形成新支撑
        if zone_15m.relationship == "15M_BELOW_1H"
           && current_price >= zone_15m.entry_range.0
           && current_price <= zone_15m.entry_range.1 {
            // 15m形成新支撑,谨慎试探
            return EntryDecision {
                action: "ENTER_WITH_CAUTION",
                price: zone_15m.entry_range.1,  // 15m上沿(保守)
                position: 15%,  // 进一步降低仓位
                stop_loss: zone_15m.stop_loss,  // 使用15m止损
                reason: "1h破位,15m新支撑试探",
            };
        } else {
            // 1h破位且15m无支撑,放弃
            return EntryDecision {
                action: "SKIP",
                price: 0.0,
                position: 0%,
                stop_loss: 0.0,
                reason: "1h破位且15m无明确支撑,放弃本次机会",
            };
        }
    }
}
```

---

### 1.3 主辅入场区决策表

| 当前价位置 | 1h主区 | 15m辅助区 | 决策 | 仓位 | 止损 |
|-----------|--------|-----------|------|------|------|
| **在1h区内** | ✅在区内 | ✅15m共振 | 优先15m下沿入场 | 30% | 1h止损 |
| **在1h区内** | ✅在区内 | ❌15m不共振 | 1h区当前价入场 | 30% | 1h止损 |
| **在1h区上** | ❌在上方 | ✅15m备选区 | 15m备选入场 | 20% | 15m止损 |
| **在1h区上** | ❌在上方 | ❌15m无区 | 等回调1h区 | 30%限价 | 1h止损 |
| **在1h区下** | ❌破位 | ✅15m新支撑 | 15m谨慎试探 | 15% | 15m止损 |
| **在1h区下** | ❌破位 | ❌15m无支撑 | 放弃本次 | 0% | - |

---

### 1.4 实际案例分析

#### 案例A: 完美共振 (1h+15m都在区间内)
```
Valuescan信号: $0.495
1h主区: $0.470 - $0.485 (置信度HIGH, 30%仓)
15m辅助区: $0.478 - $0.487 (在1h区内,置信度MEDIUM)

分析:
├─ 15m区间在1h区间内 → 完美共振
├─ 15m下沿$0.478高于1h下沿$0.470 → 更精确的入场点
└─ 当前价$0.495在两个区间上方

决策:
挂限价单 @ $0.478 (15m下沿,比1h区更优)
仓位: 30%
止损: $0.462 (1h止损,给足空间)
理由: 15m提供更精确入场点,1h提供宽止损保护
```

#### 案例B: 15m备选入场 (等1h太久,15m提供机会)
```
Valuescan信号: $0.495
1h主区: $0.460 - $0.475 (当前在上方,需等回调)
15m辅助区: $0.490 - $0.495 (在1h上方,短期支撑)

分析:
├─ 等1h回调到$0.475可能要等很久
├─ 15m在$0.490-$0.495有4根横盘平台
└─ 当前价$0.495在15m区上沿

决策:
小仓位入场 @ $0.492 (15m区下沿)
仓位: 20% (风险高,仓位减少)
止损: $0.485 (15m止损,更紧)
理由: 15m提供备选入场点,不错过机会,但降低仓位控制风险
```

#### 案例C: 1h破位,15m新支撑 (应急方案)
```
Valuescan信号: $0.465
1h主区: $0.470 - $0.485 (已破位$0.470)
15m辅助区: $0.463 - $0.470 (在1h下方,可能新支撑)

分析:
├─ 1h破位$0.470,按常规应放弃
├─ 但15m在$0.463-$0.470形成5根横盘
└─ 当前价$0.465在15m区中间

决策:
谨慎试探 @ $0.468 (15m区上沿,保守)
仓位: 15% (进一步降低)
止损: $0.460 (15m区下沿)
理由: 15m可能形成新支撑,极小仓位试错
```

---

### 1.5 小仓位试探 (动态仓位分配)

**为什么30%?**
```
风险计算:
- 满仓止损: -2% * 100% = -2%
- 小仓止损: -2% * 30% = -0.6%
- 节省试错成本: 70%!

心理优势:
- 小仓位不怕震荡
- 有70%子弹等待加仓
- 避免"满仓被套"的焦虑
```

**试探期止损** (放宽到1h支撑位):
```
入场价: $0.480
1h支撑位: $0.470
试探期止损: $0.468 (-2.5%)

为什么放宽?
- 只有30%仓位,可以承受略大回撤
- 1h支撑位更可靠
- 实际损失: -2.5% * 30% = -0.75%
```

---

## 二、加仓策略 (启动信号确认)

### 2.1 启动信号识别 (多周期综合)

**必须同时满足以下条件**:

#### 条件1: 5m启动信号 (核心)
```rust
fn detect_5m_launch_signal(klines_5m: &[Kline]) -> bool {
    let recent_3 = klines_5m.iter().rev().take(3).collect::<Vec<_>>();

    // 1. 连续3根阳线
    let all_bullish = recent_3.iter().all(|k| k.close > k.open);

    // 2. 每根实体 >0.5%
    let strong_body = recent_3.iter().all(|k| {
        let body_pct = ((k.close - k.open) / k.open) * 100.0;
        body_pct > 0.5
    });

    // 3. 成交量放大30%+
    let avg_volume_prev_5 = calculate_avg_volume(&klines_5m[..klines_5m.len()-3], 5);
    let avg_volume_recent_3 = calculate_avg_volume(&recent_3, 3);
    let volume_increase = (avg_volume_recent_3 - avg_volume_prev_5) / avg_volume_prev_5;

    all_bullish && strong_body && volume_increase > 0.3
}
```

#### 条件2: 15m趋势确认 (过滤)
```rust
fn confirm_15m_trend(klines_15m: &[Kline]) -> bool {
    let last = klines_15m.last().unwrap();
    let sma_20 = calculate_sma(&klines_15m, 20);

    // 1. 15m K线在SMA20上方
    let above_sma = last.close > sma_20;

    // 2. 最近2根15m都是阳线
    let recent_2_bullish = klines_15m.iter().rev().take(2)
        .all(|k| k.close > k.open);

    above_sma && recent_2_bullish
}
```

#### 条件3: 1h压力位突破 (确认强度)
```rust
fn check_1h_resistance_break(entry_price: f64, current_price: f64, klines_1h: &[Kline]) -> bool {
    // 找到入场后的1h短期高点
    let recent_high = klines_1h.iter().rev().take(5)
        .map(|k| k.high)
        .max();

    // 当前价格突破短期高点
    current_price > recent_high && current_price > entry_price * 1.015 // +1.5%以上
}
```

#### 条件4: 1m实时偏离度 (时机把握)
```rust
fn check_1m_realtime_strength(klines_5m: &[Kline], current_price: f64) -> bool {
    let last_5m_close = klines_5m.last().unwrap().close;
    let deviation = ((current_price - last_5m_close) / last_5m_close) * 100.0;

    // 正在形成的5m K线继续上涨 >+0.5%
    deviation > 0.5
}
```

---

### 2.2 加仓执行

**触发条件** (同时满足):
```
✅ 5m连续3根阳线 + 实体>0.5% + 成交量放大30%
✅ 15m趋势向上(在SMA20上方 + 最近2根阳线)
✅ 突破1h短期压力位 + 涨幅>+1.5%
✅ 1m实时偏离度 >+0.5%
```

**加仓参数**:
```
加仓价格: 市价(确保成交)
加仓仓位: 70%
总仓位: 100% (30%试探 + 70%加仓)

平均成本计算:
入场价 $0.480 * 30% = $0.144
加仓价 $0.495 * 70% = $0.3465
平均成本 = $0.4905

对比满仓入场:
如果一开始满仓 @ $0.495 → 成本$0.495
现在平均成本 $0.4905 → 节省0.9%!
```

**加仓后止损调整**:
```
试探期止损: $0.468 (1h支撑位, 30%仓位)
加仓后止损: $0.485 (加仓价-2%, 100%仓位)

原因:
- 加仓价$0.495已经突破,回到$0.485说明启动失败
- 保护70%加仓资金
- 但30%试探仓可能盈利$0.480→$0.485 = +1%

最坏情况:
30%盈利+1% = +0.3%
70%亏损-2% = -1.4%
总计: -1.1% (优于满仓-2%)
```

---

## 三、持仓管理 (多周期综合分析)

### 3.1 各周期的作用

#### 1m K线 - 实时偏离度
```
作用: 判断正在形成的5m K线强度

计算:
deviation = (current_price - last_5m_close) / last_5m_close * 100%

解读:
+1.5%+ : 正在形成的5m K线强势上涨 🚀
+0.5~1.5%: 小幅上涨
-0.5~+0.5%: 价格稳定
-1.5%以下: 正在形成的5m K线下跌 ⚠️

应用:
- 启动期: 1m偏离+1.5% → 加仓时机确认
- 持仓期: 1m偏离-1.5% → 警惕5m形成大阴线
```

#### 5m K线 - 启动/顶部信号
```
启动信号:
✅ 连续3根阳线 + 实体>0.5%
✅ 成交量放大30%+
✅ 突破短期阻力位

顶部信号:
🚨 长上影线 >2% + 实体<0.5% (倒锤头)
🚨 大阴线实体>1.5% + 吞没前2-3根阳线
🚨 连续2根阴线 + 成交量放大

警告信号 (60%止盈):
⚠️ 长上影线 >2% (上涨乏力)
⚠️ 单根大阴线实体>1% (多头获利回吐)
```

#### 15m K线 - 趋势确认
```
上升趋势:
✅ 15m K线持续在SMA20上方
✅ 连续2-3根阳线
✅ 低点抬高(Higher Lows)

趋势反转:
🚨 15m破位SMA20 + 大阴线
🚨 15m形成M头/双顶
🚨 连续3根阴线 + 低点破前低

应用:
- 5m启动 + 15m趋势向上 → 高概率主升浪
- 5m顶部 + 15m破位 → 立即全平
```

#### 1h K线 - 大级别支撑/阻力
```
关键位识别:
- 1h长下影线集中区 → 强支撑
- 1h前高 → 压力位
- 1h SMA50 → 中期趋势线

应用:
- 接近1h压力位 + 5m顶部信号 → 60%止盈
- 突破1h压力位 + 15m强势 → 继续持有
- 跌破1h支撑位 + 成交量放大 → 全平
```

---

### 3.2 多周期综合决策表

| 盈亏状态 | 1m偏离 | 5m信号 | 15m趋势 | 1h位置 | 决策 |
|---------|--------|--------|---------|--------|------|
| 试探期<br>(30%仓) | - | 启动信号 | 向上 | 突破压力 | **加仓70%** |
| +0~2% | +1%+ | 连续阳线 | 向上 | 中位 | 继续持有 |
| +2~5% | +0.5% | 小阳线 | 向上 | 接近压力 | 继续持有 |
| +5~8% | -0.5% | 长上影 | 向上 | 到达压力 | 观察,准备60%止盈 |
| +8%+ | -1%+ | 大阴线 | 向上 | 到达压力 | **60%止盈** |
| +8%+ | -1.5%+ | 吞没阴线 | 破位SMA | 破压力回落 | **全平** |
| +3~8% | - | - | 破位SMA | 跌破支撑 | **全平** |
| -0.5~0% | -1%+ | 阴线 | 横盘 | 中位 | 观察,接近60分钟止损 |
| -1~-1.5% | -1.5%+ | 连续阴线 | 向下 | 中位 | 30分钟快速止损准备 |
| <-1.5% | - | - | - | - | **30分钟快速止损** |

---

## 四、完整流程示例

### 示例1: 成功的主升浪 (PONDUSDT)

#### 阶段1: 信号接收与分析 (00:00)
```
Valuescan信号: PONDUSDT 主力资金异动
当前价格: $0.495
1h K线分析:
├─ 最近8h区间: $0.46 - $0.50
├─ 长下影线集中: $0.47 - $0.485
├─ 主力成本区中位: $0.4775
└─ 当前位置: 接近1h高点$0.50

决策: 等待回调到成本区
挂单: 限价买入 @ $0.485, 30%仓位
```

#### 阶段2: 试探建仓 (00:15)
```
价格回调到 $0.485 → 限价单成交
建仓价格: $0.485
仓位: 30%
止损: $0.473 (1h支撑位下方, -2.5%)
最大损失: -2.5% * 30% = -0.75%

持仓分析:
00:20 价格 $0.483 (-0.4%)
00:30 价格 $0.487 (+0.4%)
→ 在成本区内正常震荡,继续观察
```

#### 阶段3: 启动信号确认 (01:00)
```
5m K线:
├─ 最近3根: 连续阳线
├─ 实体: 0.6%, 0.8%, 0.9%
└─ 成交量放大: +35%

15m K线:
├─ 在SMA20上方
└─ 最近2根阳线

1h K线:
├─ 突破短期高点 $0.495
└─ 当前价格 $0.498 (+2.7% from entry)

1m偏离度:
└─ 5m收盘$0.497, 当前$0.498 (+0.2%)

决策: 启动信号确认!
加仓: 市价买入 @ $0.498, 70%仓位
总仓位: 100%
平均成本: $0.485*0.3 + $0.498*0.7 = $0.4941
新止损: $0.488 (加仓价-2%)
```

#### 阶段4: 主升浪期 (01:00 - 03:00)
```
01:30 价格 $0.510 (+3.2% from avg) → 继续持有
02:00 价格 $0.525 (+6.3% from avg) → 继续持有
02:30 价格 $0.540 (+9.3% from avg)
      ├─ 5m出现长上影线2.1%
      ├─ 15m仍然向上
      └─ 1h接近$0.55压力位
      决策: 观察,准备60%止盈

03:00 价格 $0.552 (+11.7% from avg)
      ├─ 5m大阴线实体1.8%
      ├─ 吞没前2根阳线
      └─ 1h到达压力位$0.55
      决策: 60%止盈 @ $0.550
      持仓: 40%
      锁定利润: (+11.3%) * 60% = +6.78%
```

#### 阶段5: 顶部确认 (03:20)
```
03:15 价格回落到 $0.540
03:20 价格 $0.545
      ├─ 5m长上影线倒锤头(上影3.2%)
      ├─ 15m破位SMA20
      └─ 成交量骤增后萎缩
      决策: 顶部信号确认,全平40% @ $0.543

最终收益:
60%仓位 @ $0.550: +11.3%
40%仓位 @ $0.543: +9.9%
总收益: 11.3%*0.6 + 9.9%*0.4 = +10.74%

杠杆10x → +107.4% ROI 🎉
```

---

### 示例2: 失败的假突破 (快速止损)

#### 阶段1: 信号与建仓 (00:00)
```
Valuescan信号: ZECUSDT
当前价格: $42.50
1h分析:
├─ 主力成本区: $41.80 - $42.20
└─ 当前在成本区上沿

决策: 小仓位建仓
入场: $42.20, 30%仓位
止损: $41.30 (1h支撑, -2.1%)
```

#### 阶段2: 试探期震荡 (00:00 - 00:30)
```
00:10 价格 $42.10 (-0.2%)
00:20 价格 $42.30 (+0.2%)
00:30 价格 $42.00 (-0.5%)
→ 正常震荡,继续观察
```

#### 阶段3: 假启动信号 (00:45)
```
5m K线: 连续2根阳线(不够3根)
15m K线: 横盘,不在SMA20上方
1h K线: 未突破前高
1m偏离: +0.3% (不够强)

决策: 启动信号不完整,不加仓
继续观察
```

#### 阶段4: 30分钟快速止损 (01:00)
```
00:50 价格 $41.80 (-0.9%)
01:00 价格 $41.55 (-1.5%)
      ├─ 持仓时间: 40分钟
      ├─ 亏损: -1.5%
      └─ 触发30分钟快速止损(<-1.5%)

决策: 30%仓位全平 @ $41.55
实际损失: -1.5% * 30% = -0.45%

后续走势:
01:30 价格 $40.80 (-3.3%) ← 如果满仓会亏更多!
02:00 价格 $40.20 (-4.7%)

总结:
小仓位试探 + 快速止损 = 仅亏-0.45%
如果满仓会亏-1.5%甚至-3%+
```

---

## 五、风险控制总结

### 5.1 多层止损机制

| 止损类型 | 触发条件 | 仓位 | 止损幅度 | 实际损失 |
|---------|---------|------|----------|---------|
| 试探期止损 | 破1h支撑 | 30% | -2.5% | -0.75% |
| 30分钟快速止损 | <-1.5% | 30%或100% | -1.5% | -0.45%或-1.5% |
| 60分钟快速止损 | <-2%或未盈利 | 100% | -2% | -2% |
| 加仓后止损 | 破加仓价-2% | 100% | 混合 | -1.1% |
| 兜底止损 | 4h未盈利 | 100% | -1~-2% | -1~-2% |

### 5.2 盈亏比优化

**对比满仓策略**:
```
满仓策略:
├─ 入场: $0.495, 100%仓位
├─ 止损: -2% → 亏损-2%
└─ 止盈: +10% → 盈利+10%
盈亏比: 10:2 = 5:1

分批策略:
├─ 试探: $0.485, 30%仓位
├─ 加仓: $0.498, 70%仓位
├─ 平均成本: $0.4941
├─ 止损: 试探期-0.75%, 满仓期-1.1%
└─ 止盈: +10.74%
盈亏比: 10.74:1.1 = 9.8:1 (提升近2倍!)
```

---

## 六、实施要点

### 6.1 关键算法模块

需要实现的核心功能:

1. **1h K线主入场区分析**:
   - 长下影线集中区识别(≥3根,下影>2%)
   - 平台支撑位识别(≥2根横盘,±0.5%范围)
   - 主力成本区中位数计算
   - 置信度评估(HIGH)

2. **15m K线辅助入场区分析**:
   - 15m平台支撑识别(≥3根横盘,±0.5%范围)
   - 15m下影线集中区(≥3根,下影>1.5%)
   - 15m MA支撑(SMA20/SMA50)
   - 与1h主区关系判断(INSIDE/ABOVE/BELOW)
   - 置信度评估(MEDIUM)

3. **主辅入场区综合决策**:
   - 当前价位置判断(在1h区内/上/下)
   - 15m关系判断(共振/备选/新支撑)
   - 动态仓位分配(15%-30%)
   - 动态止损选择(1h宽止损 vs 15m紧止损)

4. **启动信号综合判断**:
   - 5m启动信号(3连阳+成交量)
   - 15m趋势确认(SMA20+连阳)
   - 1h压力位突破
   - 1m实时偏离度

5. **多周期持仓分析**:
   - 1m实时偏离度计算
   - 5m信号识别(启动/警告/顶部)
   - 15m趋势判断
   - 1h关键位距离

6. **分批建仓管理**:
   - 试探期动态仓位管理(15%-30%)
   - 加仓信号确认
   - 平均成本计算
   - 动态止损调整

### 6.2 参数配置

```rust
pub struct StagedEntryConfig {
    // 1h主入场区参数
    pub hourly_lookback: usize,           // 8 (分析最近8根1h K线)
    pub hourly_shadow_min_pct: f64,       // 2.0% (1h长下影线阈值)
    pub hourly_shadow_cluster_min: usize, // 3 (至少3根长下影线)
    pub hourly_platform_tolerance: f64,   // 0.5% (横盘判断容差)
    pub hourly_confidence: Confidence,    // HIGH

    // 15m辅助入场区参数
    pub m15_lookback: usize,              // 30 (分析最近30根15m,即7.5小时)
    pub m15_shadow_min_pct: f64,          // 1.5% (15m长下影线阈值)
    pub m15_shadow_cluster_min: usize,    // 3 (至少3根长下影线)
    pub m15_platform_tolerance: f64,      // 0.5% (横盘判断容差)
    pub m15_platform_min_bars: usize,     // 3 (至少3根横盘)
    pub m15_confidence: Confidence,       // MEDIUM

    // 动态仓位分配
    pub position_1h_inside: f64,          // 0.30 (30%, 1h区内+15m共振)
    pub position_15m_backup: f64,         // 0.20 (20%, 15m备选入场)
    pub position_15m_new_support: f64,    // 0.15 (15%, 1h破位+15m新支撑)

    // 加仓参数
    pub add_position_ratio: f64,          // 0.7 (70%仓位)
    pub add_position_min_gain: f64,       // +1.5% (最小涨幅要求)

    // 启动信号阈值
    pub launch_consecutive_bullish: usize,  // 3 (连续阳线数)
    pub launch_body_min_pct: f64,           // 0.5% (最小实体%)
    pub launch_volume_increase: f64,        // 0.3 (成交量放大30%)

    // 快速止损(满仓后)
    pub fast_stop_30min_pct: f64,         // -1.5%
    pub fast_stop_60min_pct: f64,         // -2.0%
}

pub enum Confidence {
    HIGH,    // 1h主入场区
    MEDIUM,  // 15m辅助入场区
    LOW,     // 其他情况
}

pub enum EntryZoneRelationship {
    Inside1H,    // 15m在1h内,完美共振
    Above1H,     // 15m在1h上方,备选方案
    Below1H,     // 15m在1h下方,可能新支撑
}
```

---

## 七、预期效果

### 7.1 风险收益对比

| 指标 | 满仓策略 | 分批策略 | 改进 |
|-----|---------|---------|------|
| **试错成本** | -2% | -0.45%~-0.75% | **降低63%~73%** |
| **入场精度** | 信号价 | 成本区价 | **优化0.5%~1%** |
| **平均成本** | 高 | 优化 | **节省0.5%~1%** |
| **盈亏比** | 5:1 | 9.8:1 | **提升96%** |
| **心理压力** | 高(满仓) | 低(分批) | **显著降低** |

### 7.2 预期表现

**假设100次交易**:
```
满仓策略:
├─ 成功30次: +10% * 30 = +300%
├─ 失败70次: -2% * 70 = -140%
└─ 净收益: +160%

分批策略:
├─ 试探成功后加仓: 30次 * +10.74% = +322.2%
├─ 试探失败快速止损: 50次 * -0.6% = -30%
├─ 试探后未加仓观察: 20次 * -0.3% = -6%
└─ 净收益: +286.2% (提升79%!)
```

---

## 总结

**核心优势**:
1. ✅ **降低试错成本** - 小仓位试探,失败仅亏-0.45%~-0.75%
2. ✅ **优化入场精度** - 1h K线分析,找到主力成本区
3. ✅ **提高盈亏比** - 从5:1提升到9.8:1
4. ✅ **多周期综合** - 1m实时+5m信号+15m趋势+1h关键位
5. ✅ **心理优势** - 不怕震荡,有子弹加仓

**实施顺序**:
1. 实现1h K线入场区分析算法
2. 实现启动信号综合判断
3. 实现分批建仓逻辑
4. 实现多周期持仓分析
5. 小仓位实盘测试验证
