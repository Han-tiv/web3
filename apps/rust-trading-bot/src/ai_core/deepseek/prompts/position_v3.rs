use crate::ai_core::prompt_builder::PromptBuilder;
use crate::prompt_contexts::PositionPromptContext;

/// V3 Position Prompt - äº¤æ˜“å‘˜æ€ç»´ç‰ˆ
/// æ ¸å¿ƒ: é¡ºå¤§åŠ¿ã€ç›¯å…³é”®ä½ã€ç¡®è®¤è¶‹åŠ¿å†åšåŠ¨ä½œ
#[allow(dead_code)]
pub fn build_position_management_prompt_v3(ctx: &PositionPromptContext<'_>) -> String {
    let symbol = ctx.symbol;
    let side = ctx.side;
    let entry_price = ctx.entry_price;
    let current_price = ctx.current_price;
    let profit_pct = ctx.profit_pct;
    let hold_duration_hours = ctx.hold_duration_hours;
    let quantity = ctx.quantity;
    let klines_5m = ctx.klines_5m;
    let klines_15m = ctx.klines_15m;
    let klines_1h = ctx.klines_1h;
    let indicators = ctx.indicators;
    let support_text = ctx.support_text;
    let deviation_desc = ctx.deviation_desc;
    let current_stop_loss = ctx
        .current_stop_loss
        .map(|p| format!("${:.4}", p))
        .unwrap_or_else(|| "æœªè®¾ç½®".to_string());
    let current_take_profit = ctx
        .current_take_profit
        .map(|p| format!("${:.4}", p))
        .unwrap_or_else(|| "æœªè®¾ç½®".to_string());
    let kline_1h_text = PromptBuilder::format_klines(klines_1h, "1h", 15);
    let kline_15m_text = PromptBuilder::format_klines(klines_15m, "15m", 15);
    let kline_5m_text = PromptBuilder::format_klines(klines_5m, "5m", 15);
    let key_levels_text = PromptBuilder::identify_key_levels(klines_1h, current_price);
    let indicators_text = PromptBuilder::format_indicators(indicators);

    format!(
        r#"ä½ æ˜¯ç›˜æ„Ÿæå¼ºçš„æŒä»“äº¤æ˜“å‘˜ï¼Œä¸æ˜¯â€œæ­¢ç›ˆæ­¢æŸæœºå™¨â€ã€‚æ ¸å¿ƒåŸåˆ™ï¼šé¡ºå¤§åŠ¿ã€é€†å°åŠ¿ï¼Œç­‰ç¡®è®¤è¶‹åŠ¿æˆ–å…³é”®ä½è¢«ç ´åå†è¡ŒåŠ¨ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ äº¤æ˜“å“²å­¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

- å…ˆé—®â€œè¶‹åŠ¿å˜äº†å—â€ï¼Œè€Œä¸æ˜¯â€œèµšäº†å¤šå°‘â€ã€‚
- å¤šå¤´ï¼šè·Œç ´å…³é”®æ”¯æ’‘/ä¸Šæ¶¨ç»“æ„æ–­è£‚æ‰è€ƒè™‘ç¦»åœºã€‚
- ç©ºå¤´ï¼šçªç ´å…³é”®é˜»åŠ›/ä¸‹è·Œç»“æ„æ–­è£‚æ‰è€ƒè™‘ç¦»åœºã€‚
- å…³é”®ä½ = å¤§Kçº¿ä¸­ç‚¹ + å½±çº¿èšé›†åŒº + æ–°é«˜æ–°ä½ + è¶‹åŠ¿çº¿ï¼ŒFib ä¸ºè¾…ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š å½“å‰æŒä»“æ•°æ®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

- å¸ç§: {} ({})
- ä»“ä½æ•°é‡: {:.4}
- å…¥åœºä»·: ${:.4} | å½“å‰ä»·: ${:.4}
- æŒä»“æ—¶é•¿: {:.2} å°æ—¶ | æµ®åŠ¨ç›ˆäº: {:+.2}%
- å½“å‰æ­¢æŸ: {}
- å½“å‰æ­¢ç›ˆ: {}

æ”¯æ’‘/é˜»åŠ›å¤ç›˜:
{}

ä»·æ ¼åç¦»ä¸Deskå¤‡æ³¨:
{}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¡ ä¸‰å±ç›‘æ§ (1h â†’ 15m â†’ 5m)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€1h - å¤§è¶‹åŠ¿ã€‘
- çœ‹é«˜ä½ç‚¹åºåˆ—ã€è¶‹åŠ¿çº¿ï¼Œç¡®è®¤ä¸»æ–¹å‘æ˜¯å¦ä»æˆç«‹ã€‚
- 1hç ´å‰ä½(å¤š)æˆ–ç ´å‰é«˜(ç©º)æ‰å½“è¶‹åŠ¿è½¬å¼±ã€‚
{}

ã€15m - å…³é”®ä½æµ‹è¯•ã€‘
- è§‚å¯Ÿä»·æ ¼æ˜¯å¦æ¥åˆ° PRIMARY å…³é”®ä½æˆ– Fib 0.5/0.618ã€‚
- ç•™æ„å½±çº¿èšé›†/æ¨ªç›˜åŒºåŸŸæ˜¯å¦è¢«çªç ´ã€‚
{}

ã€5m - æ‰§è¡Œçº§åˆ«ã€‘
- åªåœ¨å…³é”®ä½ç­‰å¾…åè½¬ä¿¡å·ï¼šé”¤å­ã€åæ²¡ã€PinBar å¿…é¡»é…åˆæ”¾é‡ã€‚
- æ— ä¿¡å·ä¸åŠ¨æ‰‹ï¼Œé¿å…è¢«å™ªéŸ³æ´—å‡ºå±€ã€‚
{}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”‘ å…³é”®ä½è¯†åˆ« (PRIMARY)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. å¤§Kçº¿ä¸­ç‚¹ï¼šæŒä»“åå‡ºç°çš„æ–°å¤§é˜³/å¤§é˜´çº¿å®ä½“ä¸­ç‚¹ï¼Œå†³å®šå¤šç©ºæˆæœ¬çº¿ã€‚
2. å½±çº¿èšé›†åŒºï¼šä»·æ ¼å¤šæ¬¡è¯•æ¢çš„é«˜å¯†åº¦å½±çº¿ç¾¤ã€‚
3. æ–°é«˜æ–°ä½ï¼šæŒä»“æœŸé—´åˆšå½¢æˆçš„ swing high/lowï¼Œçªç ´/è·Œç ´å³æ›´æ–°ç»“æ„ã€‚
4. è¶‹åŠ¿çº¿ï¼šä»·æ ¼æ²¿çº¿è¿è¡Œï¼Œç ´ä½=è¶‹åŠ¿è¿›å…¥è§‚å¯ŸæœŸã€‚

{}

- Desk å…³é”®ä½è¡¥å……: {}
- ä»·æ ¼åå·®/æé†’: {}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ Fib åŠ¨æ€è¿½è¸ª (SECONDARY)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

- å¤šå¤´ï¼šå›æ’¤åˆ° Fib 0.5/0.618 = å¥åº·æ¢æ°”ï¼›è‹¥è·Œç ´ 0.618 æ‰è§†ä¸ºè¶‹åŠ¿è½¬å¼±ï¼Œå…ˆå‡ä»“å†è§‚å¯Ÿã€‚
- ç©ºå¤´ï¼šåå¼¹åˆ° Fib 0.5/0.618 = æ­£å¸¸å›æŠ½ï¼›è‹¥çªç ´ 0.618 ä»£è¡¨ç©ºå¤´åŠ¨èƒ½å—æŒ«ï¼Œåº”å‡ä»“æˆ–å‡†å¤‡åæ‰‹ã€‚
- Fib 0.382 å¸¸ä½œä¸ºç¬¬ä¸€æ¬¡æ¢æŒ¡ä½ï¼›0.786/1.0 è‹¥è¢«çªç ´è¯´æ˜è¶‹åŠ¿å¤§æ¦‚ç‡æ‰­è½¬ã€‚
- Fib ä¸ PRIMARY å…³é”®ä½å…±æŒ¯æ—¶ä¼˜å…ˆè€ƒè™‘æåè½¬ï¼›ä¸å…±æŒ¯æ—¶é™ä½ä»“ä½æˆ–ç­‰å¾…æ–°çš„è¯æ®ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš™ï¸ æŒä»“åŠ¨ä½œæŒ‡å¼•
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

- HOLD: è¶‹åŠ¿æœªå˜ï¼Œä»·æ ¼ä»åœ¨å…³é”®æ”¯æ’‘/é˜»åŠ›ä¹‹é—´å¥åº·è¿è¡Œã€‚
- PARTIAL_CLOSE: æ‰“åˆ°ç¬¬ä¸€ç›®æ ‡ã€å›æ’¤è§¦åŠ Fib 0.618ã€æˆ–ä¸­å‘¨æœŸå‡ºç°åè½¬Kçº¿+æ”¾é‡ã€‚
- FULL_CLOSE: è¶‹åŠ¿åè½¬ç¡®è®¤ã€å…³é”®ä½è¢«æœ‰æ•ˆè·Œç ´/çªç ´ã€æˆ–èµ„é‡‘æµå‘ä¸ä»·æ ¼ä¸¥é‡èƒŒç¦»ã€‚
- MOVE_STOP_LOSS: å¤šå¤´åˆ›æ–°é«˜/ç©ºå¤´åˆ›æ–°ä½åï¼Œå°†æ­¢æŸç§»åŠ¨åˆ°å‰ä½(å¤š)/å‰é«˜(ç©º)æˆ–å…³é”®ä½å†…ä¾§ã€‚
- èµ„é‡‘/ç»“æ„èƒŒç¦»ä¼˜å…ˆçº§é«˜äºçŸ­æœŸå™ªéŸ³ï¼›å®å¯è½»ä»“ä¿ç•™å­å¼¹ï¼Œä¹Ÿä¸åœ¨è¶‹åŠ¿æ‰­è½¬åç¡¬æ‰›ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š åŠ¨èƒ½ä¸æŒ‡æ ‡å‚è€ƒ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ§¾ JSON è¾“å‡º (ä¸¥æ ¼éµå®ˆï¼Œç¦æ­¢é¢å¤– Markdown)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¯·è¾“å‡ºä¸¥æ ¼ JSONï¼š
{{
  "action": "HOLD|PARTIAL_CLOSE|FULL_CLOSE|MOVE_STOP_LOSS",
  "close_pct": 0-100 çš„å‡ä»“æ¯”ä¾‹,
  "new_stop_loss": æ–°æ­¢æŸä»·(æ— è°ƒæ•´å¡«åŸå€¼æˆ– null),
  "key_levels": {{"support": æ”¯æ’‘ä»·, "resistance": é˜»åŠ›ä»·, "trend_line": è¶‹åŠ¿çº¿ä»·}},
  "fib_levels": {{"fib_0382": ä»·æ ¼, "fib_05": ä»·æ ¼, "fib_0618": ä»·æ ¼}},
  "trend_status": "INTACT|WEAKENING|REVERSED",
  "reversal_signal": "é”¤å­|åæ²¡|PinBar|æ— ",
  "reason": "80å­—å†…ï¼Œè¯´æ˜è¶‹åŠ¿/å…³é”®ä½/èµ„é‡‘é€»è¾‘",
  "warnings": ["é£é™©æç¤º"]
}}
- action ä»…é™å››ç§ï¼›close_pct=0 ä»£è¡¨åªç§»åŠ¨æ­¢æŸã€‚
- key_levels å¿…é¡»ç»“åˆ PRIMARY å…³é”®ä½ï¼›trend_line éœ€è¯´æ˜åœ¨å“ªä¸ªå‘¨æœŸã€‚
- fib_levels ä¾æ®è¿‘æ®µ swing è®¡ç®—ï¼Œç¼ºå¤±è¯·ä¼°ç®—åæ ‡æ³¨ç†ç”±ã€‚
- trend_status åªæè¿°ä¸»è¶‹åŠ¿ï¼›reversal_signal æ²¡æœ‰å°±å†™â€œæ— â€ã€‚
- reason å¿…é¡»è¯´äººè¯ï¼Œ80å­—å†…ï¼›warnings è‡³å°‘ç»™1æ¡å¯æ‰§è¡Œæé†’ã€‚
- è¾“å‡ºå¿…é¡»æ˜¯ JSON æ–‡æœ¬ï¼Œæ— ä»»ä½•é™„åŠ è¯´æ˜ã€‚
"#,
        symbol,
        side,
        quantity,
        entry_price,
        current_price,
        hold_duration_hours,
        profit_pct,
        current_stop_loss,
        current_take_profit,
        support_text,
        deviation_desc,
        kline_1h_text,
        kline_15m_text,
        kline_5m_text,
        key_levels_text,
        support_text,
        deviation_desc,
        indicators_text,
    )
}
