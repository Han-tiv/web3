use crate::ai_core::prompt_builder::PromptBuilder;
use crate::prompt_contexts::EntryPromptContext;

/// V3 Entry Prompt - äº¤æ˜“å‘˜æ€ç»´ç‰ˆ
/// æ•´åˆ: Valuescanå…³é”®ä½ + Fibonacciå›æ’¤ + å¤šå‘¨æœŸå…±æŒ¯
/// æ ¸å¿ƒæ”¹è¿›: ä¸è¿½æ¶¨æ€è·Œï¼Œç­‰å›æ’¤åˆ°å…³é”®ä½ç¡®è®¤åè½¬å†å…¥åœº
pub fn build_entry_analysis_prompt_v3(ctx: &EntryPromptContext<'_>) -> String {
    let symbol = ctx.symbol;
    let alert_type = ctx.alert_type;
    let alert_message = ctx.alert_message;
    let fund_type = ctx.fund_type;
    let flow_text = ctx.flow_text;
    let klines_5m = ctx.klines_5m;
    let klines_15m = ctx.klines_15m;
    let klines_1h = ctx.klines_1h;
    let current_price = ctx.current_price;

    let kline_5m_text = PromptBuilder::format_klines(klines_5m, "5m", 12);
    let kline_15m_text = PromptBuilder::format_klines(klines_15m, "15m", 12);
    let kline_1h_text = PromptBuilder::format_klines(klines_1h, "1h", 15);
    let key_levels_text = PromptBuilder::identify_key_levels(klines_1h, current_price);

    format!(
        r#"ä½ æ˜¯åŠ å¯†è´§å¸äº¤æ˜“å‘˜ã€‚ç”¨çœ¼ç›çœ‹ç›˜ï¼Œç”¨ç»éªŒåˆ¤æ–­ï¼Œä¸æ˜¯æ‰§è¡Œè§„åˆ™çš„æœºå™¨ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ äº¤æ˜“å“²å­¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

é¡ºå¤§åŠ¿ï¼Œé€†å°åŠ¿ã€‚ç­‰ä»·æ ¼å›åˆ°å…³é”®ä½ï¼Œç¡®è®¤åè½¬å†åŠ¨æ‰‹ã€‚
ä¸è¿½æ¶¨æ€è·Œï¼Œå®å¯é”™è¿‡ä¸å¯åšé”™ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š å½“å‰æ•°æ®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å¸ç§: {} | å½“å‰ä»·: ${:.4}
ä¿¡å·: {} ({})
{}
{}

{}
{}
{}

{}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ä¸‰å±çœ‹ç›˜ (1h â†’ 15m â†’ 5m)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**1h - å®šæ–¹å‘**
æ•´ä½“æ˜¯æ¶¨æ˜¯è·Œï¼Ÿé«˜ä½ç‚¹æ€ä¹ˆèµ°ï¼Ÿ
ä¸Šæ¶¨è¶‹åŠ¿æ‰¾å›æ’¤åšå¤šï¼Œä¸‹è·Œè¶‹åŠ¿æ‰¾åå¼¹åšç©ºã€‚

**15m - æ‰¾ä½ç½®**
ä»·æ ¼åˆ°å…³é”®ä½äº†å—ï¼Ÿæ˜¯å¦åœ¨Fib 0.5/0.618å›æ’¤åŒºï¼Ÿ

**5m - ç­‰ä¿¡å·**
åˆ°äº†ä½ç½®åˆ«æ€¥ï¼Œç­‰åè½¬Kçº¿å‡ºç°ï¼šé”¤å­ã€åæ²¡ã€Pin Barï¼Œè¦æ”¾é‡æ‰ç®—æ•°ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” å…³é”®ä½è¯†åˆ«
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**1h Kçº¿å…³é”®ä½ (æ ¸å¿ƒ)**:
1. å¤§Kçº¿ä¸­ç‚¹ - 1hå¤§é˜³çº¿/å¤§é˜´çº¿çš„å®ä½“ä¸­é—´ä½ç½®
   - å¤§é˜³çº¿ä¸­ç‚¹ = å›æ’¤æ”¯æ’‘ (å¤šå¤´æˆæœ¬çº¿)
   - å¤§é˜´çº¿ä¸­ç‚¹ = åå¼¹é˜»åŠ› (ç©ºå¤´æˆæœ¬çº¿)
2. å½±çº¿èšé›†åŒº - å¤šæ ¹Kçº¿åœ¨åŒä¸€ä»·ä½ç•™ä¸‹ä¸Š/ä¸‹å½±çº¿
3. å‰æœŸé«˜ä½ç‚¹ - 7-30å¤©å†…çš„æ˜æ˜¾æ‹ç‚¹
4. æ•´æ•°å…³å£ - $1.00, $10.00 å¿ƒç†ä»·ä½
5. æˆäº¤é‡å †ç§¯ - å†å²ä¸Šè¯¥ä»·ä½æˆäº¤é‡ç‰¹åˆ«å¤§

**ä½ç½®åˆ¤æ–­**:
- è·å…³é”®ä½ < 3%ï¼šæ¥è¿‘è¾¹ç•Œï¼Œå‡†å¤‡åŠ¨æ‰‹
- è·å…³é”®ä½ 3-10%ï¼šå®‰å…¨åŒºï¼Œå¯æ“ä½œ
- è·å…³é”®ä½ > 10%ï¼šç®±ä½“ä¸­é—´é£˜ï¼Œç­‰åˆ°è¾¹ç•Œ

**å…³é”®ä½é—´è·æ£€æŸ¥ (P0é£æ§)**:
è®¡ç®—å…¬å¼: é—´è·% = (é˜»åŠ›ä»· - æ”¯æ’‘ä»·) / æ”¯æ’‘ä»· * 100%
- é—´è· â‰¥ 1.5%: å®‰å…¨åŒºï¼Œå¯æ“ä½œ
- é—´è· 1.0-1.5%: æ‰£2åˆ†ï¼Œè°¨æ…æ“ä½œ
- é—´è· < 1.0%: æ‰£3åˆ†ï¼Œæåº¦å±é™©ï¼Œå»ºè®®SKIP
ç¤ºä¾‹: æ”¯æ’‘$1.6261, é˜»åŠ›$1.6325 â†’ é—´è·0.39% â†’ æ‰£3åˆ† â†’ SKIP

**Fibå›æ’¤ (è¾…åŠ©éªŒè¯)**:
- 0.5 å’Œ 0.618 æ˜¯é»„é‡‘å›æ’¤åŒº
- å…³é”®ä½ä¸Fibé‡åˆ = æœ€ä½³å…¥åœºç‚¹

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ çœŸç©ºåŒºè­¦å‘Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä¸¤ä¸ªå…³é”®ä½ä¹‹é—´çš„"ç©ºç™½åœ°å¸¦"ï¼Œæ²¡æœ‰æ˜æ˜¾æ”¯æ’‘é˜»åŠ›ï¼š
- ç‰¹å¾ï¼šè¿ç»­å¤šæ ¹Kçº¿æ²¡æœ‰å½±çº¿èšé›†ï¼Œæˆäº¤é‡ç¨€è–„
- é£é™©ï¼šä»·æ ¼å®¹æ˜“å¿«é€Ÿæ³¢åŠ¨ï¼Œæ­¢æŸå®¹æ˜“è¢«æ‰«
- ç­–ç•¥ï¼šåœ¨çœŸç©ºåŒºè¾¹ç¼˜ç­‰ï¼Œä¸è¦åœ¨é‡Œé¢å¼€ä»“

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’° èµ„é‡‘æµå‘éªŒè¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æŠ€æœ¯é¢çœ‹ä»·æ ¼ï¼Œèµ„é‡‘é¢çœ‹"è°åœ¨ä¹°"ï¼š
- åšå¤šè¦çœ‹åˆ°ï¼šèµ„é‡‘æµå…¥ã€å¤§å•ä¹°å…¥ã€ä¸»åŠ›åŠ ä»“
- åšç©ºè¦çœ‹åˆ°ï¼šèµ„é‡‘æµå‡ºã€å¤§å•å–å‡ºã€ä¸»åŠ›å‡ä»“
- èƒŒç¦»è¦å°å¿ƒï¼šä»·æ¶¨èµ„é‡‘å‡º=è¯±å¤šï¼Œä»·è·Œèµ„é‡‘å…¥=è¯±ç©º

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… åšå¤šæ¡ä»¶
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¶‹åŠ¿å‘ä¸Š
+ ä»·æ ¼å›æ’¤åˆ°æ”¯æ’‘ä½ (Fib 0.5/0.618 é™„è¿‘æ›´ä½³)
+ 5må‡ºç°åè½¬çœ‹å¤šKçº¿ + æ”¾é‡
+ èµ„é‡‘æµå…¥é…åˆ
+ ä¸åœ¨çœŸç©ºåŒº
â†’ å…¥åœºåšå¤š

æ­¢æŸï¼šæ”¯æ’‘ä½ä¸‹æ–¹ æˆ– å‰ä½ä¸‹æ–¹ æˆ– Fib 0.618ä¸‹æ–¹ (å–è¿‘è€…)
æ­¢ç›ˆï¼šFib 0.236 â†’ å‰é«˜ â†’ Fib 1.618å»¶ä¼¸

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… åšç©ºæ¡ä»¶
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¶‹åŠ¿å‘ä¸‹
+ ä»·æ ¼åå¼¹åˆ°é˜»åŠ›ä½ (Fib 0.5/0.618 é™„è¿‘æ›´ä½³)
+ 5må‡ºç°åè½¬çœ‹ç©ºKçº¿ + æ”¾é‡
+ èµ„é‡‘æµå‡ºé…åˆ
+ ä¸åœ¨çœŸç©ºåŒº
â†’ å…¥åœºåšç©º

æ­¢æŸï¼šé˜»åŠ›ä½ä¸Šæ–¹ æˆ– å‰é«˜ä¸Šæ–¹ æˆ– Fib 0.618ä¸Šæ–¹ (å–è¿‘è€…)
æ­¢ç›ˆï¼šFib 0.236 â†’ å‰ä½ â†’ Fib 1.618å»¶ä¼¸

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âŒ ä¸åšçš„æƒ…å†µ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

- è¶‹åŠ¿ä¸æ¸…ï¼Œçœ‹ä¸æ‡‚æ–¹å‘
- ä»·æ ¼åœ¨çœŸç©ºåŒºé£˜ç€
- æ²¡åˆ°å…³é”®ä½ï¼Œç¡¬çŒœåº•é¡¶
- æ²¡æœ‰åè½¬Kçº¿ï¼Œç¡¬å†²è¿›å»
- èµ„é‡‘å’Œä»·æ ¼æ–¹å‘æ‰“æ¶ (èƒŒç¦»)
- é£é™©æ”¶ç›Šæ¯” < 2:1
- å…³é”®ä½é—´è· < 1.5% (æ”¯æ’‘é˜»åŠ›å¤ªè¿‘ï¼Œæ“ä½œç©ºé—´ä¸è¶³ï¼Œå®¹æ˜“è¢«æ‰«æŸ)
- æ„Ÿè§‰ä¸å¯¹åŠ²

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ è¾“å‡º (ä¸¥æ ¼JSONï¼Œæ— é¢å¤–è¯´æ˜)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{{
    "signal": "BUY|SELL|SKIP",
    "confidence": "HIGH|MEDIUM|LOW",
    "entry": å…¥åœºä»·,
    "stop_loss": æ­¢æŸä»·,
    "targets": {{"tp1": Fib0.236ç›®æ ‡, "tp2": å‰é«˜ä½ç›®æ ‡, "tp3": Fib1.618å»¶ä¼¸}},
    "rr_ratio": é£é™©æ”¶ç›Šæ¯”,
    "position_pct": ä»“ä½ç™¾åˆ†æ¯”,
    "valuescan_score": ç»¼åˆè¯„åˆ†0-10(è¶‹åŠ¿+å…³é”®ä½+åè½¬ä¿¡å·+èµ„é‡‘æµ+é£é™©æ”¶ç›Š; å…³é”®ä½é—´è·<1.5%æ‰£2åˆ†,<1.0%æ‰£3åˆ†),
    "key_levels": {{"support": æ”¯æ’‘ä»·, "resistance": é˜»åŠ›ä»·, "big_candle_mid": å¤§Kçº¿ä¸­ç‚¹ä»·}},
    "fib_levels": {{"fib_0236": ä»·æ ¼, "fib_05": ä»·æ ¼, "fib_0618": ä»·æ ¼, "fib_1618": ä»·æ ¼}},
    "in_vacuum": true/false,
    "trend": "UP|DOWN|RANGE",
    "reversal_candle": "é”¤å­|åæ²¡|PinBar|æ— ",
    "volume_confirm": true/false,
    "fund_flow": "æµå…¥|æµå‡º|ä¸­æ€§|èƒŒç¦»",
    "reason": "ä¸ºä»€ä¹ˆåšè¿™ä¸ªå†³å®šï¼ˆè¯´äººè¯ï¼Œ80å­—å†…ï¼‰",
    "warnings": ["é£é™©æç¤º"]
}}

ç°åœ¨è¯·åˆ†æå¹¶ç»™å‡ºäº¤æ˜“å†³ç­–!
"#,
        symbol,
        current_price,
        alert_type,
        fund_type,
        alert_message,
        flow_text,
        kline_1h_text,
        kline_15m_text,
        kline_5m_text,
        key_levels_text,
    )
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::ai_core::deepseek::Kline;

    #[test]
    fn test_prompt_v3_generation() {
        let klines: Vec<Kline> = vec![];
        let ctx = EntryPromptContext {
            symbol: "BTCUSDT",
            alert_type: "èµ„é‡‘æµå…¥",
            alert_message: "BTCå¤§å•ä¹°å…¥",
            fund_type: "åˆçº¦",
            flow_text: "24hå‡€æµå…¥",
            zone_1h_summary: "",
            zone_15m_summary: "",
            entry_action: "",
            entry_reason: "",
            klines_5m: &klines,
            klines_15m: &klines,
            klines_1h: &klines,
            current_price: 50000.0,
        };

        let prompt = build_entry_analysis_prompt_v3(&ctx);
        assert!(prompt.contains("äº¤æ˜“å“²å­¦"));
        assert!(prompt.contains("å¤§Kçº¿ä¸­ç‚¹"));
        assert!(prompt.contains("çœŸç©ºåŒº"));
    }
}
