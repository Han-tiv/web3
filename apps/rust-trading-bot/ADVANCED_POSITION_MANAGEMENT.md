# 🎯 完整版方案：智能多级支撑位 + 动态分级止盈系统

## 一、方案概览

### 核心理念
```
"让利润奔跑，让风险可控"
- 盈利时：分级止盈，保留仓位捕捉更大空间
- 亏损时：智能止损，不是机械地-1%就走，而是基于支撑位+资金流+趋势综合判断
- 持仓时长：动态调整（标准1-2小时，趋势延续最多6小时）
```

---

## 二、数据输入层（5周期K线）

### 多周期K线配置
```rust
1m K线：30根（30分钟）
├─ 作用：极短期趋势识别
├─ 优先级：最高（立即反转信号）
└─ 用途：1m连续3根反转K线 → 立即平仓

5m K线：50根（4.2小时）
├─ 作用：微观趋势 + 短期支撑位
├─ 优先级：高
└─ 用途：5m反转确认 → 部分平仓/全部平仓

15m K线：100根（25小时）
├─ 作用：短期趋势 + Level 1支撑位
├─ 优先级：中
└─ 用途：识别短期支撑位（部分止盈位）

1h K线：48根（48小时）
├─ 作用：主力关键位 + 成交量分析
├─ 优先级：中（参考）
└─ 用途：识别Level 2/3支撑位（核心止盈/止损位）

实时价格：mark_price
├─ 作用：实时偏离度分析
└─ 用途：判断正在形成的K线方向
```

---

## 三、完整版支撑位识别（5大算法）

### 算法1：成交量堆积法 ⭐核心算法
```rust
原理：主力建仓的价格区域，成交量会显著放大

实现步骤：
1. 将价格按0.5%分段（例如 $0.95-0.96, $0.96-0.97...）
2. 统计每个价格区间的累计成交量
3. 成交量最大的区间 = 主力建仓位

示例：
价格区间        1h累计成交量    判断
$0.95-0.96     150,000       普通
$0.96-0.97     280,000       较大
$0.97-0.98     520,000       ⭐ 主力支撑位（成交量峰值）
$0.98-0.99     320,000       普通
$0.99-1.00     450,000       较大

强度评分：根据成交量大小，5-10分
```

### 算法2：下影线密集法
```rust
原理：多根K线的下影线集中在某个价位，说明主力多次护盘

实现步骤：
1. 找出最近20根有下影线的K线
2. 统计下影线最低点的分布
3. 最低点密集区域（±1%内有3次以上）= 支撑位

示例：
K10: 下影线最低点 $0.975
K15: 下影线最低点 $0.978
K18: 下影线最低点 $0.972
K22: 下影线最低点 $0.976
K25: 下影线最低点 $0.974

解读：5根K线的下影线集中在 $0.972-0.978（平均$0.975）
强度评分：5 + 触碰次数（最高10分）
```

### 算法3：前期平台法
```rust
原理：价格曾经横盘的区域，主力吸筹位，具有支撑作用

实现步骤：
1. 找连续5根以上K线收盘价波动 < 2% 的区域
2. 该区域 = 前期平台（主力吸筹区）

示例（1h K线）：
K05-K10: 收盘价在 $0.95-0.97 区间震荡（6根K线）
K15-K25: 收盘价在 $1.02-1.05 区间震荡（11根K线）⭐ 主力吸筹区
K30: 价格突破到 $1.15

解读：$1.02-1.05 是主力建仓区，价格回调到此会获得支撑
强度评分：7分（固定）
```

### 算法4：均线共振法
```rust
原理：多条重要均线集中的位置，多重技术位叠加，支撑力度更强

实现步骤：
1. 计算多条均线：SMA20, SMA50, BOLL中轨
2. 如果多条均线在±1%范围内聚集 → 共振支撑位

示例：
SMA20:        $0.980
SMA50:        $0.970
BOLL中轨:      $0.975

解读：3条均线集中在 $0.970-0.980（平均$0.975），形成均线共振支撑
强度评分：6 + 聚集均线数量（最高10分）
```

### 算法5：斐波那契回撤法
```rust
原理：黄金分割位是市场自然的支撑/阻力位

实现步骤：
1. 找最近波段高低点（最近20根K线）
2. 计算斐波那契回撤位：38.2%, 50%, 61.8%, 78.6%
3. 找最接近当前价格下方的斐波那契位

示例：
波段高点: $1.20
波段低点: $0.90
区间: $0.30

斐波那契回撤位：
- 38.2%: $1.20 - $0.30 × 0.382 = $1.085
- 50%:   $1.20 - $0.30 × 0.5   = $1.050 ⭐ 黄金分割位
- 61.8%: $1.20 - $0.30 × 0.618 = $1.015
- 78.6%: $1.20 - $0.30 × 0.786 = $0.964

强度评分：8分（固定）
```

---

## 四、多级支撑位分级（3级9个子位）

### Level 1: 短期支撑（15m级别）⭐ 部分止盈位
```
识别周期：15m K线
支撑位数量：3个
强度评级：★★☆☆☆（容易突破）

子支撑位来源：
1️⃣ 15m BOLL下轨（动态支撑）
   - 强度：6分
   - 作用：短期超卖反弹位

2️⃣ 15m下影线密集区（护盘位）
   - 强度：5-10分（根据触碰次数）
   - 作用：短期主力护盘位置

3️⃣ 15m成交量堆积区（主力建仓位）
   - 强度：5-10分（根据成交量大小）
   - 作用：短期主力吸筹区

交易策略：
✅ 盈利时接近Level 1 + 1m出现长上影线 → 部分止盈 50%-60%
✅ 目的：锁定部分利润，保留仓位等待更大空间
```

### Level 2: 中期支撑（1h级别）⭐ 二次止盈位
```
识别周期：1h K线
支撑位数量：3个
强度评级：★★★☆☆（较强支撑）

子支撑位来源：
1️⃣ 1h SMA20（重要均线）
   - 强度：7分
   - 作用：中期趋势支撑

2️⃣ 1h前期平台位（主力吸筹区）
   - 强度：7分
   - 作用：历史横盘区支撑

3️⃣ 1h下影线密集区（中期护盘位）
   - 强度：5-10分（根据触碰次数）
   - 作用：中期主力护盘位置

交易策略：
✅ 跌破Level 1后向Level 2靠近 → 观察是否获得支撑
✅ 盈利时接近Level 2 + 5m反转确认 → 再次部分止盈（剩余50%）
✅ 亏损时守住Level 2 + 出现反弹 → HOLD，等待反弹
✅ 跌破Level 2 + 成交量萎缩 → PARTIAL_CLOSE 50%
```

### Level 3: 关键支撑（核心防线）⭐ 全部止损位
```
识别周期：1h K线
支撑位数量：3-5个
强度评级：★★★★★（核心支撑，破位必走）

子支撑位来源：
1️⃣ 1h SMA50（重要均线）
   - 强度：9分
   - 作用：长期趋势支撑

2️⃣ 入场保本位（entry_price × 0.99）
   - 强度：10分
   - 作用：心理支撑，保护本金

3️⃣ 1h最大成交量堆积区（核心建仓位）
   - 强度：8-10分（根据成交量峰值）
   - 作用：主力核心建仓位置

4️⃣ 均线共振位（多均线叠加）
   - 强度：7-10分（根据聚集均线数量）
   - 作用：多重技术位支撑

5️⃣ 斐波那契黄金分割位（61.8%）
   - 强度：8分
   - 作用：自然回撤支撑

交易策略：
🚨 跌破Level 3任意支撑位 → 进入警戒状态
🚨 触发以下任一条件 → 立即全部平仓：
   ├─ 跌破Level 3最强支撑位（入场保本位）
   ├─ 跌破Level 3 + 成交量放大（主力出逃）
   ├─ 跌破Level 3 + 1m/5m连续反转无反弹
   └─ 亏损 < -2%（硬止损）
```

---

## 五、动态分级止盈/止损决策引擎

### 盈利模式：3级止盈策略

#### 第一次止盈（50%-60%）
```
触发条件（任一满足）：
✅ 当前价格接近Level 1短期支撑（距离<2%）
✅ 1m出现明显长上影线（上影线>实体2倍）
✅ 5m出现反转K线但未确认（长上影线）
✅ RSI > 70（超买）+ 接近Level 1

执行操作：
├─ PARTIAL_CLOSE 50%-60%
├─ 保留剩余仓位（40%-50%）
├─ 移动止损到入场价+1%（保护利润）
└─ 日志：记录止盈原因和价格

理念：锁定部分利润，降低回撤风险，保留仓位捕捉更大空间
```

#### 第二次止盈（剩余50%）
```
触发条件（任一满足）：
✅ 跌破Level 1，向Level 2靠近（距离<2%）
✅ 5m出现明显反转确认（大阴线吞没）
✅ 15m MACD死叉
✅ 持仓时长>2小时 + 盈利<+5%（收益不达预期）

执行操作：
├─ PARTIAL_CLOSE 剩余50%（即总仓位的20%-25%）
├─ 保留核心仓位（20%-25%）
├─ 移动止损到入场价+2%（保护更多利润）
└─ 日志：记录止盈原因和价格

理念：再次锁定利润，只保留核心仓位博取最大利润
```

#### 第三次止盈（全部平仓）
```
触发条件（任一满足）：
✅ 跌破Level 2，向Level 3靠近
✅ 1m/5m连续反转且无反弹迹象
✅ 持仓时长>4小时 + 盈利开始回吐（从最高点回落>3%）
✅ 接收到Valuescan反向信号（空单信号）

执行操作：
├─ FULL_CLOSE 全部平仓
├─ 清理持仓追踪器
└─ 日志：记录最终收益率

理念：趋势已变，完全离场，保护利润
```

---

### 亏损模式：智能止损策略

#### 轻微亏损阶段（0% ~ -1%）
```
判断逻辑：
├─ 检查当前价格与Level 2中期支撑的距离
├─ 如果距离Level 2 > 3% → HOLD，观察
├─ 如果距离Level 2 < 3% → 进入警戒状态
└─ 如果在Level 2上方获得支撑（1m出现长下影线）→ HOLD

执行操作：
├─ HOLD（继续观察）
├─ 增加监控频率（每2.5分钟检查一次）
└─ 日志：记录当前价格和最近支撑位

理念：轻微亏损不轻易止损，观察支撑位是否有效
```

#### 中度亏损阶段（-1% ~ -2%）
```
判断逻辑：
├─ 已跌破Level 2中期支撑
├─ 向Level 3关键支撑靠近
├─ 检查成交量：
│  ├─ 成交量放大 → 主力出逃，风险高
│  └─ 成交量萎缩 → 可能只是回调
└─ 检查1m/5m K线形态：
   ├─ 出现长下影线反弹 → 有反弹迹象，可以观察
   └─ 连续阴线无反弹 → 趋势破坏，风险高

执行操作（两种策略）：
策略A（高风险）：
├─ 跌破Level 2 + 成交量放大 + 连续阴线
├─ → PARTIAL_CLOSE 50%
└─ 保留50%仓位，等待Level 3支撑

策略B（低风险）：
├─ 跌破Level 2 + 在Level 3上方获得支撑
├─ → HOLD
└─ 移动止损到Level 3 - 0.5%

理念：中度亏损需警惕，根据支撑位和成交量判断是否部分止损
```

#### 重度亏损阶段（< -2%）
```
判断逻辑：
├─ 已接近或跌破Level 3关键支撑
├─ 检查是否触发硬止损条件：
│  ├─ 跌破入场保本位（entry_price × 0.99）
│  ├─ 跌破Level 3最强支撑 + 成交量放大
│  └─ 1m/5m连续3根大阴线无反弹

执行操作：
├─ FULL_CLOSE 立即全部平仓
├─ 不抱任何幻想，保护本金
└─ 日志：记录止损原因和最终亏损

理念：破位必走，不抗单，保护本金是第一要务
```

---

### 成交量判断（辅助）

#### 成交量放大判断
```
算法：
1. 计算最近5根K线的平均成交量：avg_volume
2. 当前K线成交量 > avg_volume × 1.5 → 成交量放大

下跌 + 成交量放大：
├─ 解读：主力出逃，抛压沉重
└─ 操作：降低支撑位信任度，提前止损

下跌 + 成交量萎缩：
├─ 解读：可能只是回调，主力未出逃
└─ 操作：信任支撑位，观察反弹

上涨 + 成交量放大：
├─ 解读：主力拉升，趋势强劲
└─ 操作：持仓，让利润奔跑
```

---

## 六、动态持仓时长管理

### 标准模式（默认）
```
持仓时长：1-2小时
适用场景：大部分普通交易

触发离场条件：
├─ 持仓 > 2小时 且盈亏 < +1% → 主动离场（效率不高）
├─ 持仓 > 1.5小时 且出现反转信号 → 降低持仓
└─ 持仓时长不影响止盈/止损规则（支撑位优先）
```

### 趋势延续模式（触发条件）
```
持仓时长：最多6小时
适用场景：趋势非常明确时

触发条件（需同时满足）：
✅ 多周期趋势一致（1m/5m/15m/1h均多头排列）
✅ 成交量持续放大（资金持续流入）
✅ RSI 50-70区间（非极端超买）
✅ 盈利 > +3%（已有利润垫）
✅ 价格在Level 1支撑位上方（未破位）

延续持仓规则：
├─ 每小时检查一次趋势是否破坏
├─ 出现任一反转信号 → 立即离场
├─ 最多持仓6小时后强制离场
└─ 持仓期间遵守分级止盈规则

理念：趋势强劲时不要过早离场，让利润奔跑
```

---

## 七、AI Prompt模板优化

```rust
你是专业的超短线持仓管理分析师，请基于"分级止盈、智能止损"原则分析当前持仓。

【持仓信息】
- 交易对: {symbol}
- 持仓方向: {side}
- 入场价格: ${entry_price}
- 当前价格: ${current_price}
- 当前盈亏: {profit_pct}%
- 持仓时长: {duration} 小时

⚠️ 【实时价格动态】
- 1m最后收盘价: ${last_1m_close} ({time_ago}秒前)
- 当前实时价格: ${current_price}
- 正在形成的1m K线: {price_direction} ({deviation}%)
- 说明：{real_time_analysis}

【1m K线 - 最近30根】（极短期趋势，30分钟）
{klines_1m_text}

【5m K线 - 最近15根】（微观趋势，1.25小时）
{klines_5m_text}

【15m K线 - 最近15根】（短期趋势，3.75小时）
{klines_15m_text}

【1h K线 - 最近12根】（关键位，12小时）
{klines_1h_text}

【技术指标】
{indicators_text}

【当前技术状况】
{trend_analysis}

{support_analysis_full_text}  ← ⭐ 完整版支撑位分析

🎯【分级止盈/止损策略】

📈 **盈利时（盈亏 > 0%）**：

第一次止盈（PARTIAL_CLOSE 50%-60%）：
├─ 触发条件：
│  ├─ 当前价格接近Level 1短期支撑（距离<2%）
│  ├─ 1m出现明显长上影线（上影线>实体2倍）
│  ├─ 5m出现反转K线但未确认
│  └─ RSI > 70 + 接近Level 1
├─ 执行：部分平仓50%-60%
└─ 目的：锁定部分利润，保留仓位

第二次止盈（PARTIAL_CLOSE 剩余50%）：
├─ 触发条件：
│  ├─ 跌破Level 1，向Level 2靠近
│  ├─ 5m明显反转确认（大阴线吞没）
│  ├─ 15m MACD死叉
│  └─ 持仓>2h + 盈利<+5%
├─ 执行：再次部分平仓50%
└─ 目的：再次锁定利润，只保留核心仓位

第三次止盈（FULL_CLOSE）：
├─ 触发条件：
│  ├─ 跌破Level 2，向Level 3靠近
│  ├─ 1m/5m连续反转无反弹
│  ├─ 持仓>4h + 利润回吐>3%
│  └─ 收到Valuescan反向信号
├─ 执行：全部平仓
└─ 目的：趋势已变，完全离场

继续持有（HOLD）：
├─ 条件：1m/5m/15m趋势延续 + 距离Level 1 > 3%
├─ 理念：让利润奔跑，不急于止盈
└─ 注意：持续监控支撑位

📉 **亏损时（盈亏 < 0%）**：

轻微亏损（0% ~ -1%）：
├─ 观察Level 2中期支撑
├─ 距离Level 2 > 3% → HOLD
├─ 距离Level 2 < 3% + 获得支撑 → HOLD
└─ 理念：轻微亏损不轻易止损

中度亏损（-1% ~ -2%）：
├─ 已跌破Level 2，向Level 3靠近
├─ 判断：
│  ├─ 成交量放大 + 连续阴线 → PARTIAL_CLOSE 50%
│  └─ 成交量萎缩 + 在Level 3获得支撑 → HOLD
└─ 理念：根据支撑位和成交量判断

重度亏损（< -2%）或跌破Level 3：
├─ 触发条件：
│  ├─ 跌破入场保本位
│  ├─ 跌破Level 3 + 成交量放大
│  └─ 1m/5m连续3根大阴线无反弹
├─ 执行：FULL_CLOSE 立即全部平仓
└─ 理念：破位必走，不抗单

⏰【持仓时长管理】
- 标准模式：1-2小时（持仓>2h且盈利<1% → 主动离场）
- 趋势延续模式：最多6小时（需多周期一致+成交量放大+盈利>3%）

【输出要求】
必须以JSON格式返回持仓管理决策:
{
    "action": "HOLD|PARTIAL_CLOSE|FULL_CLOSE|SET_LIMIT_ORDER",
    "close_percentage": 平仓百分比(PARTIAL_CLOSE时必填,如50.0表示50%),
    "target_support_level": "触发的支撑位级别(Level1/Level2/Level3)",
    "reason": "详细分析理由(必含1m信号+5m趋势+支撑位分析+盈亏状态+持仓时长)",
    "profit_potential": "HIGH|MEDIUM|LOW|NONE",
    "optimal_exit_price": AI判断的最优退出价(可选),
    "confidence": "HIGH|MEDIUM|LOW",
    "risk_assessment": "当前风险评估(低/中/高)"
}
```

---

## 八、完整实现清单

### Phase 1: 核心功能实现 ✅
- [x] 完整版支撑位识别系统（5大算法）
  - [x] 算法1: 成交量堆积法
  - [x] 算法2: 下影线密集法
  - [x] 算法3: 前期平台法
  - [x] 算法4: 均线共振法
  - [x] 算法5: 斐波那契回撤法

### Phase 2: 集成到持仓监控
- [ ] 修改 `build_position_management_prompt` 增加支撑位分析
- [ ] 在持仓监控中调用 `SupportAnalyzer`
- [ ] 增加1m K线获取（已完成，需调整数量为30根）
- [ ] 增加实时价格偏离度分析

### Phase 3: 优化决策规则
- [ ] 修改AI Prompt模板（分级止盈/智能止损）
- [ ] 增加成交量判断逻辑
- [ ] 实现动态持仓时长管理

### Phase 4: 测试和验证
- [ ] 编译测试
- [ ] 模拟场景测试（盈利/亏损不同阶段）
- [ ] 实盘验证

---

## 九、预期效果

### 盈利场景
```
开多单 $1.00 → 上涨到 $1.10（+10%）

传统方式：
├─ 可能在 $1.05 就全部平仓（+5%）
└─ 错过后续 $1.05 → $1.10 的利润

完整版方案：
├─ $1.05 接近Level 1 → 部分止盈50%（锁定+2.5%）
├─ $1.08 接近Level 2 → 再止盈25%（锁定+2.0%）
├─ 保留25%仓位到 $1.10 → 全部平仓（+2.5%）
└─ 总收益：+7%（比传统方式多+2%）

理念：分级止盈，既保护利润，又不错过大行情
```

### 亏损场景
```
开多单 $1.00 → 下跌

传统方式：
├─ $0.99（-1%）立即全部平仓
└─ 如果是假突破，错过反弹机会

完整版方案：
├─ $0.99（-1%）→ 检查Level 2支撑（$0.97）
├─ 距离Level 2还有2% → HOLD观察
├─ 价格在Level 2获得支撑，出现反弹 → 继续持有
└─ 如果跌破Level 3（$0.95）→ 全部平仓（-2%）

理念：智能止损，不是机械地-1%就走，给支撑位一个机会
```

---

## 十、风险提示

1. **支撑位不是绝对的**：支撑位可能被突破，需结合成交量和K线形态判断
2. **过度交易风险**：分级止盈会增加交易次数，注意手续费成本
3. **趋势延续模式风险**：持仓6小时风险较大，需严格遵守离场规则
4. **AI误判风险**：AI可能误判支撑位强度，需人工监控异常情况

---

## 十一、总结

完整版方案整合了：
- ✅ 5大算法识别主力支撑位（成交量+下影线+平台+均线+斐波那契）
- ✅ 3级9个子支撑位（短期/中期/关键）
- ✅ 动态分级止盈（50% → 30% → 20%）
- ✅ 智能止损（不是机械地-1%，而是基于支撑位+成交量+趋势）
- ✅ 1m K线（30根）实时监控
- ✅ 实时价格偏离度分析
- ✅ 动态持仓时长（1-6小时）

核心理念："让利润奔跑，让风险可控"
